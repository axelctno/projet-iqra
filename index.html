<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Apprendre l'Arabe â€” Application ComplÃ¨te</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Amiri:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        button,
        a,
        select,
        .dictee-speaker,
        .alpha-card {
            touch-action: manipulation;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: radial-gradient(circle at top right, #1a1a3e, #0a0a1a);
            color: #f0f0ff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        /* GLOBAL ARABIC STYLE IMPROVEMENTS */
        [lang="ar"],
        .amiri,
        .ar-big,
        .ar-word,
        .ar-char,
        .dictee-reveal,
        .tashkeel-display,
        .alpha-card .ch,
        .example-box,
        .d-input-display,
        .bd-char {
            font-family: 'Amiri', serif;
            direction: rtl;
            line-height: 1.6;
            text-rendering: optimizeLegibility;
            font-feature-settings: "kern", "liga", "clig", "calt";
            white-space: nowrap;
            /* EmpÃªche l'empilement vertical */
            display: inline-block;
            /* Garantit que le bloc respecte la direction et les connexions */
            unicode-bidi: isolate;
        }

        .ar {
            font-family: 'Amiri', 'Traditional Arabic', serif;
        }

        /* GAMIFICATION BAR */
        .gami-bar {
            display: flex;
            gap: 15px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            max-width: 750px;
            width: 100%;
            margin-bottom: 12px;
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.06);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 14px;
        }

        .gami-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            font-weight: 700;
        }

        .gami-item .emoji {
            font-size: 20px;
        }

        .gami-item .val {
            color: #a29bfe;
            font-size: 16px;
        }

        .xp-mini-bar {
            width: 80px;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .xp-mini-fill {
            height: 100%;
            background: linear-gradient(90deg, #6c5ce7, #a29bfe);
            transition: width 0.4s;
        }

        /* TABS */
        .tabs {
            display: flex;
            max-width: 750px;
            width: 100%;
            margin-bottom: 15px;
            border-radius: 12px;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.06);
            flex-wrap: wrap;
        }

        .tab {
            flex: 1;
            padding: 12px 8px;
            font-size: 13px;
            background: transparent;
            color: rgba(255, 255, 255, 0.45);
            border: none;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.3s;
            min-width: 110px;
            text-align: center;
        }

        .tab.active {
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
            color: #fff;
            box-shadow: 0 4px 15px rgba(108, 92, 231, 0.4);
        }

        .tab:hover:not(.active) {
            background: rgba(255, 255, 255, 0.06);
            color: rgba(255, 255, 255, 0.7);
        }

        /* SECTIONS */
        .section {
            display: none;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            padding: 28px;
            border-radius: 16px;
            max-width: 750px;
            width: 100%;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            animation: fadeIn 0.3s ease;
        }

        .section.visible {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* TYPOGRAPHY */
        h2.sec-title {
            text-align: center;
            font-size: 22px;
            margin-bottom: 4px;
            background: linear-gradient(135deg, #a29bfe, #6c5ce7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .sec-sub {
            text-align: center;
            color: rgba(255, 255, 255, 0.4);
            font-size: 14px;
            margin-bottom: 18px;
        }

        /* PROGRESS */
        .prog-wrap {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 18px;
        }

        .prog-bar-bg {
            flex: 1;
            height: 10px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 5px;
            overflow: hidden;
        }

        .prog-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #00b894, #00cec9);
            transition: width 0.5s;
            border-radius: 5px;
        }

        .prog-text {
            font-size: 13px;
            font-weight: 700;
            color: #00cec9;
            white-space: nowrap;
        }

        /* SELECT */
        select {
            padding: 10px 14px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.12);
            background: rgba(255, 255, 255, 0.08);
            color: #e8e8f0;
            font-size: 14px;
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            width: 100%;
            margin-bottom: 14px;
        }

        select option {
            background: #1a1a3e;
            color: #e8e8f0;
        }

        /* ARABIC DISPLAY */
        .ar-big {
            font-size: clamp(60px, 15vw, 90px);
            text-align: center;
            color: #f0f0ff;
            margin: 15px 0;
            text-shadow: 0 0 30px rgba(108, 92, 231, 0.3);
            display: block;
            /* Conteneur parent en bloc pour centrage */
            width: 100%;
        }

        .ar-word {
            display: block;
            /* Conteneur parent en bloc */
            width: 100%;
            font-size: clamp(40px, 10vw, 70px);
            text-align: center;
            color: #f0f0ff;
            background: rgba(255, 255, 255, 0.04);
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            border: 1px solid rgba(255, 255, 255, 0.06);
        }

        .highlight {
            color: #ff7675;
            font-weight: bold;
        }

        .example-box {
            font-size: 40px;
            font-family: 'Amiri', serif;
            background: rgba(255, 255, 255, 0.04);
            padding: 14px;
            border-radius: 10px;
            text-align: center;
            line-height: 1.4;
            display: none;
            border: 1px solid rgba(255, 255, 255, 0.06);
        }

        /* INPUTS */
        .inp-group {
            margin: 12px 0;
            text-align: left;
        }

        .inp-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
        }

        .inp-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            font-size: 16px;
            /* 16px to prevent iOS auto-zoom */
            background: rgba(255, 255, 255, 0.06);
            color: #e8e8f0;
            outline: none;
            transition: border 0.3s;
            font-family: 'Inter', sans-serif;
        }

        .inp-group input:focus {
            border-color: #6c5ce7;
        }

        /* BUTTONS */
        .btns {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 18px;
        }

        .btn {
            border: none;
            padding: 11px 20px;
            font-size: 14px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.3s;
            font-family: 'Inter', sans-serif;
        }

        .btn-primary {
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
            color: #fff;
            box-shadow: 0 4px 12px rgba(108, 92, 231, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(108, 92, 231, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #00b894, #00cec9);
            color: #fff;
            display: none;
        }

        .btn-success:hover {
            transform: translateY(-2px);
        }

        .btn-audio {
            background: linear-gradient(135deg, #e17055, #fdcb6e);
            color: #fff;
            display: none;
        }

        .btn-audio:hover {
            transform: translateY(-2px);
        }

        .btn-audio2 {
            background: linear-gradient(135deg, #6c5ce7, #fd79a8);
            color: #fff;
            display: none;
        }

        .btn-audio2:hover {
            transform: translateY(-2px);
        }

        .btn-restart {
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
            color: #fff;
            font-size: 16px;
            padding: 14px 28px;
        }

        /* FEEDBACK */
        .feedback {
            margin-top: 16px;
            font-size: 16px;
            font-weight: 700;
            min-height: 30px;
            text-align: center;
        }

        .correct {
            color: #00b894;
        }

        .incorrect {
            color: #ff7675;
        }

        .tip {
            display: none;
            background: rgba(108, 92, 231, 0.1);
            border-left: 4px solid #6c5ce7;
            padding: 14px;
            margin-top: 16px;
            border-radius: 0 8px 8px 0;
            font-size: 14px;
            line-height: 1.5;
            color: rgba(255, 255, 255, 0.8);
        }

        /* VICTORY */
        .victory {
            display: none;
            text-align: center;
            padding: 35px 0;
        }

        .victory h2 {
            color: #00b894;
            font-size: 28px;
            margin-bottom: 8px;
        }

        .victory p {
            color: rgba(255, 255, 255, 0.5);
            font-size: 16px;
            margin-bottom: 25px;
        }

        /* BREAKDOWN */
        .bd-wrap {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 20px;
            direction: rtl;
            background: rgba(255, 255, 255, 0.04);
            padding: 14px;
            border-radius: 12px;
            border: 2px dashed rgba(255, 255, 255, 0.1);
        }

        .bd-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: rgba(255, 255, 255, 0.06);
            padding: 10px 14px;
            border-radius: 8px;
            border-bottom: 3px solid;
            min-width: 65px;
        }

        .bd-char {
            font-size: 36px;
            margin-bottom: 4px;
        }

        .bd-desc {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            line-height: 1.3;
            text-align: center;
        }

        .bd-plus {
            font-size: 22px;
            color: rgba(255, 255, 255, 0.2);
            font-weight: bold;
            padding: 0 4px;
        }

        /* ALPHABET GRID */
        .alpha-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(85px, 1fr));
            gap: 12px;
            margin-top: 16px;
            direction: rtl;
        }

        .alpha-card {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            padding: 12px 5px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .alpha-card:hover {
            transform: translateY(-4px);
            border-color: #6c5ce7;
            background: rgba(108, 92, 231, 0.1);
            box-shadow: 0 6px 16px rgba(108, 92, 231, 0.2);
        }

        .alpha-card .ch {
            font-size: 42px;
            font-family: 'Amiri', serif;
            color: #f0f0ff;
            margin-bottom: 4px;
        }

        .alpha-card .nm {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.5);
            font-weight: 700;
        }

        .alpha-card .forms {
            font-size: 18px;
            font-family: 'Amiri', serif;
            color: rgba(255, 255, 255, 0.35);
            margin-top: 4px;
            letter-spacing: 6px;
        }

        .alpha-card.rebel {
            border-color: rgba(255, 107, 107, 0.3);
        }

        .alpha-card.rebel .rebel-tag {
            display: inline-block;
            font-size: 9px;
            background: rgba(255, 107, 107, 0.2);
            color: #ff7675;
            padding: 2px 6px;
            border-radius: 4px;
            margin-top: 4px;
        }

        /* STATS */
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
            margin: 16px 0;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }

        .stat-card .st-val {
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 4px;
        }

        .stat-card .st-lbl {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.4);
            font-weight: 600;
        }

        .weak-list {
            margin-top: 14px;
        }

        .weak-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.04);
            border-radius: 8px;
            margin-bottom: 6px;
        }

        .weak-item .ar {
            font-size: 28px;
            font-family: 'Amiri', serif;
        }

        .weak-item .wi-info {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.5);
        }

        /* TASHKEEL */
        .tashkeel-display {
            font-size: clamp(60px, 15vw, 110px);
            text-align: center;
            color: #f0f0ff;
            margin: 10px 0;
            text-shadow: 0 0 30px rgba(108, 92, 231, 0.3);
        }

        .tashkeel-ref {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 8px;
            margin: 14px 0;
        }

        .tashkeel-card {
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
        }

        .tashkeel-card .tc-ar {
            font-size: 36px;
            font-family: 'Amiri', serif;
            color: #a29bfe;
        }

        .tashkeel-card .tc-nm {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.4);
            font-weight: 700;
        }

        .tashkeel-card .tc-snd {
            font-size: 12px;
            color: #00cec9;
            font-weight: 600;
        }

        /* TOAST */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 14px 22px;
            border-radius: 10px;
            font-weight: 700;
            font-size: 14px;
            z-index: 999;
            transform: translateX(120%);
            transition: transform 0.4s ease;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast-xp {
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
            color: #fff;
        }

        .toast-streak {
            background: linear-gradient(135deg, #fdcb6e, #e17055);
            color: #fff;
        }

        .toast-level {
            background: linear-gradient(135deg, #00b894, #00cec9);
            color: #fff;
        }

        @media(max-width:500px) {
            .ar-big {
                font-size: 65px;
            }

            .inp-group input {
                font-size: 16px;
                /* EmpÃªche le zoom auto sur iOS */
            }

            .btn {
                padding: 14px 20px;
                /* Plus facile Ã  cliquer */
            }

            .ar-word {
                font-size: 50px;
            }

            .tashkeel-display {
                font-size: 80px;
            }

            .tab {
                font-size: 11px;
                padding: 10px 5px;
                min-width: 80px;
            }
        }

        /* DICTEE */
        .dictee-speaker {
            width: 100px;
            height: 100px;
            margin: 20px auto;
            border-radius: 50%;
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 8px 30px rgba(108, 92, 231, 0.4);
            animation: pulse-speaker 2s ease infinite;
        }

        .dictee-speaker:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 40px rgba(108, 92, 231, 0.6);
        }

        @keyframes pulse-speaker {

            0%,
            100% {
                box-shadow: 0 8px 30px rgba(108, 92, 231, 0.4);
            }

            50% {
                box-shadow: 0 8px 40px rgba(108, 92, 231, 0.7);
            }
        }

        .dictee-hint {
            text-align: center;
            color: rgba(255, 255, 255, 0.4);
            font-size: 13px;
            margin-bottom: 16px;
        }

        .dictee-reveal {
            text-align: center;
            font-size: clamp(40px, 12vw, 60px);
            color: #f0f0ff;
            margin: 15px 0;
            display: none;
            width: 100%;
        }

        .d-input-display {
            width: 100%;
            min-height: 70px;
            padding: 14px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.06);
            color: #f0f0ff;
            font-size: clamp(24px, 6vw, 36px);
            text-align: center;
            margin-bottom: 12px;
            cursor: text;
            transition: border-color 0.3s;
            display: block;
            /* ChangÃ© de flex Ã  block pour Ã©viter l'alignement vertical des lettres */
            overflow-x: auto;
            overflow-y: hidden;
        }

        .d-input-display:focus-within {
            border-color: #6c5ce7;
        }

        .vk-wrap {
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 14px;
            padding: 12px;
            margin-bottom: 14px;
        }

        .vk-label {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.35);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .vk-row {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            justify-content: center;
            margin-bottom: 6px;
        }

        .vk-key {
            min-width: 38px;
            height: 40px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.08);
            color: #f0f0ff;
            font-family: 'Amiri', serif;
            font-size: 22px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 6px;
        }

        .vk-key:hover {
            background: rgba(108, 92, 231, 0.3);
            transform: translateY(-2px);
        }

        .vk-key:active {
            transform: scale(0.95);
        }

        .vk-key-tashkeel {
            background: rgba(162, 155, 254, 0.15);
            border: 1px solid rgba(162, 155, 254, 0.2);
            font-size: 26px;
            min-width: 46px;
            height: 46px;
        }

        .vk-key-tashkeel:hover {
            background: rgba(162, 155, 254, 0.35);
        }

        .vk-key-action {
            background: rgba(108, 92, 231, 0.2);
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            font-weight: 700;
            min-width: 60px;
        }

        .vk-key-action:hover {
            background: rgba(108, 92, 231, 0.4);
        }
    </style>
</head>

<body>
    <!-- GAMIFICATION BAR -->
    <div class="gami-bar">
        <div class="gami-item"><span class="emoji">ğŸ”¥</span><span class="val" id="g-streak">0</span> <span>jours</span>
        </div>
        <div class="gami-item"><span class="emoji">â­</span><span>Niv.</span><span class="val" id="g-level">1</span>
        </div>
        <div class="gami-item"><span class="emoji">ğŸ’</span><span class="val" id="g-xp">0</span><span>XP</span>
            <div class="xp-mini-bar">
                <div class="xp-mini-fill" id="g-xp-bar" style="width:0%"></div>
            </div>
        </div>
    </div>
    <!-- TABS -->
    <div class="tabs" id="tabs-container"></div>
    <!-- TOAST -->
    <div class="toast toast-xp" id="toast"></div>
    <!-- SECTION: QUIZ LETTRES -->
    <div class="section visible" id="sec-letters">
        <h2 class="sec-title">ğŸ“ Formes des Lettres</h2>
        <p class="sec-sub">Identifie la lettre et sa position</p>
        <select id="family-filter" onchange="resetLetterQuiz()"></select>
        <div class="prog-wrap">
            <div class="prog-bar-bg">
                <div class="prog-bar-fill" id="l-prog"></div>
            </div><span class="prog-text" id="l-prog-txt">0/0</span>
        </div>
        <div class="victory" id="l-victory">
            <h2>ğŸ‰ Famille TerminÃ©e !</h2>
            <p>Tu as maÃ®trisÃ© toutes les formes.</p><button class="btn btn-restart"
                onclick="resetLetterQuiz()">Relancer</button>
        </div>
        <div id="l-core">
            <div class="ar-big" id="l-char">Ù€Ø¨Ù€</div>
            <div class="example-box" id="l-word"></div>
            <div class="inp-group"><label>Nom de la lettre :</label><input type="text" id="l-inp-name"
                    placeholder="ex: sin, ayn..." autocomplete="off"></div>
            <div class="inp-group"><label>Position (dÃ©but, milieu, fin, isolÃ©e) :</label><input type="text"
                    id="l-inp-pos" placeholder="Tape la position" autocomplete="off"></div>
            <div class="btns">
                <button class="btn btn-primary" id="l-submit" onclick="checkLetter()">Valider</button>
                <button class="btn btn-audio" id="l-audio1" onclick="playAudio(curLetter.audioChar)">ğŸ”Š Lettre</button>
                <button class="btn btn-audio2" id="l-audio2" onclick="playAudio(curLetter.audioWord)">ğŸ”Š Mot</button>
                <button class="btn btn-success" id="l-next" onclick="nextLetter()">Suivant â”</button>
            </div>
            <div id="l-fb" class="feedback"></div>
            <div id="l-tip" class="tip"></div>
        </div>
    </div>
    <!-- SECTION: MOTS -->
    <div class="section" id="sec-words">
        <h2 class="sec-title">ğŸ“– Lecture de Mots</h2>
        <p class="sec-sub">Lis ce mot et Ã©cris sa phonÃ©tique</p>
        <select id="word-diff" onchange="resetWordQuiz()">
            <option value="all">Tous les mots</option>
            <option value="short">Mots courts (2-3 lettres)</option>
            <option value="medium">Mots moyens (4 lettres)</option>
            <option value="long">Mots longs (5+ lettres)</option>
        </select>
        <div class="prog-wrap">
            <div class="prog-bar-bg">
                <div class="prog-bar-fill" id="w-prog"></div>
            </div><span class="prog-text" id="w-prog-txt">0/0</span>
        </div>
        <div class="victory" id="w-victory">
            <h2>ğŸ‰ SÃ©rie TerminÃ©e !</h2>
            <p>Tous les mots sont maÃ®trisÃ©s. Bravo !</p><button class="btn btn-restart"
                onclick="resetWordQuiz()">Refaire</button>
        </div>
        <div id="w-core">
            <div class="ar-word" id="w-display">Ø¨ÙÙŠÙ’Øª</div>
            <div class="inp-group"><label>PhonÃ©tique du mot :</label><input type="text" id="w-inp"
                    placeholder="ex: bayt, kitab..." autocomplete="off"></div>
            <div class="btns">
                <button class="btn btn-primary" id="w-submit" onclick="checkWord()">Valider</button>
                <button class="btn btn-audio" id="w-audio" onclick="playAudio(curWord.arabic)">ğŸ”Š Ã‰couter</button>
                <button class="btn btn-success" id="w-next" onclick="nextWord()">Suivant â”</button>
            </div>
            <div id="w-fb" class="feedback"></div>
            <div id="w-bd"></div>
        </div>
    </div>
    <!-- SECTION: TASHKEEL -->
    <div class="section" id="sec-tashkeel">
        <h2 class="sec-title">âœï¸ Voyelles & Tashkeel</h2>
        <p class="sec-sub">Identifie le signe diacritique et prononce la syllabe</p>
        <div class="tashkeel-ref" id="tashkeel-ref"></div>
        <div class="prog-wrap">
            <div class="prog-bar-bg">
                <div class="prog-bar-fill" id="t-prog"></div>
            </div><span class="prog-text" id="t-prog-txt">0/0</span>
        </div>
        <div class="victory" id="t-victory">
            <h2>ğŸ‰ Tashkeel MaÃ®trisÃ© !</h2>
            <p>Tu connais toutes les voyelles arabes.</p><button class="btn btn-restart"
                onclick="resetTashkeelQuiz()">Relancer</button>
        </div>
        <div id="t-core">
            <div class="tashkeel-display" id="t-display">Ø¨Ù</div>
            <div class="inp-group"><label>Comment se prononce cette syllabe ?</label><input type="text" id="t-inp"
                    placeholder="ex: ba, bi, bu..." autocomplete="off"></div>
            <div class="btns">
                <button class="btn btn-primary" id="t-submit" onclick="checkTashkeel()">Valider</button>
                <button class="btn btn-audio" id="t-audio" onclick="playAudio(curTash.audio)">ğŸ”Š Ã‰couter</button>
                <button class="btn btn-success" id="t-next" onclick="nextTashkeel()">Suivant â”</button>
            </div>
            <div id="t-fb" class="feedback"></div>
        </div>
    </div>
    <!-- SECTION: SYLLABES -->
    <div class="section" id="sec-syllables">
        <h2 class="sec-title">ğŸ§© Construction de Syllabes</h2>
        <p class="sec-sub">MÃ©thode Nour Al-Bayan â€” lettre + voyelle</p>
        <select id="syl-filter" onchange="resetSylQuiz()">
            <option value="fatha">SÃ©rie Fatha (Ø¨Ù ØªÙ Ø«Ù...)</option>
            <option value="kasra">SÃ©rie Kasra (Ø¨Ù ØªÙ Ø«Ù...)</option>
            <option value="damma">SÃ©rie Damma (Ø¨Ù ØªÙ Ø«Ù...)</option>
            <option value="all">Toutes les voyelles (mÃ©lange)</option>
        </select>
        <div class="prog-wrap">
            <div class="prog-bar-bg">
                <div class="prog-bar-fill" id="s-prog"></div>
            </div><span class="prog-text" id="s-prog-txt">0/0</span>
        </div>
        <div class="victory" id="s-victory">
            <h2>ğŸ‰ SÃ©rie TerminÃ©e !</h2>
            <p>Tu maÃ®trises ces syllabes !</p><button class="btn btn-restart" onclick="resetSylQuiz()">Relancer</button>
        </div>
        <div id="s-core">
            <div class="tashkeel-display" id="s-display">Ø¨Ù</div>
            <div class="inp-group"><label>Lis cette syllabe :</label><input type="text" id="s-inp"
                    placeholder="ex: ba, ti, khu..." autocomplete="off"></div>
            <div class="btns">
                <button class="btn btn-primary" id="s-submit" onclick="checkSyl()">Valider</button>
                <button class="btn btn-audio" id="s-audio" onclick="playAudio(curSyl.audio)">ğŸ”Š Ã‰couter</button>
                <button class="btn btn-success" id="s-next" onclick="nextSyl()">Suivant â”</button>
            </div>
            <div id="s-fb" class="feedback"></div>
        </div>
    </div>
    <!-- SECTION: DICTEE -->
    <div class="section" id="sec-dictee">
        <h2 class="sec-title">ğŸ§ DictÃ©e</h2>
        <p class="sec-sub">Ã‰coute et Ã©cris en arabe ce que tu entends</p>
        <select id="dictee-mode" onchange="resetDicteeQuiz()">
            <option value="words">Mots</option>
            <option value="syllables">Syllabes</option>
        </select>
        <div class="prog-wrap">
            <div class="prog-bar-bg">
                <div class="prog-bar-fill" id="d-prog"></div>
            </div><span class="prog-text" id="d-prog-txt">0/0</span>
        </div>
        <div class="victory" id="d-victory">
            <h2>ğŸ‰ DictÃ©e TerminÃ©e !</h2>
            <p>Tu as une oreille en or !</p><button class="btn btn-restart"
                onclick="resetDicteeQuiz()">Relancer</button>
        </div>
        <div id="d-core">
            <div class="dictee-speaker" id="d-speaker" onclick="playDictee()">ğŸ”Š</div>
            <p class="dictee-hint">Clique pour rÃ©Ã©couter</p>
            <div class="dictee-reveal" id="d-reveal"></div>
            <label
                style="display:block;margin-bottom:5px;font-weight:600;font-size:14px;color:rgba(255,255,255,0.7)">Ã‰cris
                en arabe :</label>
            <div class="d-input-display" id="d-inp"></div>
            <div class="vk-wrap">
                <div class="vk-label">Lettres</div>
                <div class="vk-row" id="vk-letters"></div>
                <div class="vk-label" style="margin-top:8px">Tashkeel (voyelles)</div>
                <div class="vk-row" id="vk-tashkeel"></div>
                <div class="vk-row" style="margin-top:6px">
                    <button class="vk-key vk-key-action" id="mic-btn" onclick="vkMic()">ğŸ¤ Voix</button>
                    <button class="vk-key vk-key-action" onclick="vkBackspace()">âŒ« Effacer</button>
                    <button class="vk-key vk-key-action" onclick="vkClear()">ğŸ—‘ Tout</button>
                </div>
            </div>
            <div class="btns">
                <button class="btn btn-primary" id="d-submit" onclick="checkDictee()">Valider</button>
                <button class="btn btn-success" id="d-next" onclick="nextDictee()">Suivant â”</button>
            </div>
            <div id="d-fb" class="feedback"></div>
        </div>
    </div>
    <!-- SECTION: ALPHABET -->
    <div class="section" id="sec-alphabet">
        <h2 class="sec-title">ğŸ”  Alphabet Arabe</h2>
        <p class="sec-sub">Clique pour Ã©couter â€” les 4 formes de chaque lettre</p>
        <div class="alpha-grid" id="alpha-grid"></div>
    </div>
    <!-- SECTION: STATS -->
    <div class="section" id="sec-stats">
        <h2 class="sec-title">ğŸ“Š Statistiques</h2>
        <p class="sec-sub">Ton tableau de bord d'apprentissage</p>
        <div class="stat-grid" id="stat-grid"></div>
        <h3 style="margin:18px 0 8px;font-size:16px;color:rgba(255,255,255,0.6);">ğŸ”» Tes points faibles</h3>
        <div id="weak-list" class="weak-list"></div>
    </div>
    <script>
        // ===== UTILITIES =====
        function norm(s) { return s.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().trim(); }

        // Optimisation Mobile : Primer le TTS pour iOS/Android
        let ttsPrimed = false;
        function primeTTS() {
            if (!ttsPrimed && 'speechSynthesis' in window) {
                const u = new SpeechSynthesisUtterance('');
                u.volume = 0; window.speechSynthesis.speak(u);
                ttsPrimed = true;
            }
        }
        document.addEventListener('touchstart', primeTTS, { once: true });
        document.addEventListener('click', primeTTS, { once: true });

        function playAudio(t) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel(); // Fix bug file d'attente iOS Safari
                const u = new SpeechSynthesisUtterance(t);
                u.lang = 'ar-SA';
                u.rate = 0.5;
                window.speechSynthesis.speak(u);
            }
        }
        let toastTimer;
        function showToast(msg, cls = 'toast-xp') { const t = document.getElementById('toast'); t.className = 'toast ' + cls; t.textContent = msg; t.classList.add('show'); clearTimeout(toastTimer); toastTimer = setTimeout(() => t.classList.remove('show'), 2500); }

        // ===== TABS =====
        const TABS = [{ id: 'letters', icon: 'ğŸ“', label: 'Lettres' }, { id: 'words', icon: 'ğŸ“–', label: 'Mots' }, { id: 'tashkeel', icon: 'âœï¸', label: 'Tashkeel' }, { id: 'syllables', icon: 'ğŸ§©', label: 'Syllabes' }, { id: 'dictee', icon: 'ğŸ§', label: 'DictÃ©e' }, { id: 'alphabet', icon: 'ğŸ” ', label: 'Alphabet' }, { id: 'stats', icon: 'ğŸ“Š', label: 'Stats' }];
        let curTab = 'letters';
        function initTabs() { const c = document.getElementById('tabs-container'); TABS.forEach(t => { const b = document.createElement('button'); b.className = 'tab' + (t.id === 'letters' ? ' active' : ''); b.textContent = t.icon + ' ' + t.label; b.onclick = () => switchTab(t.id); b.id = 'tab-' + t.id; c.appendChild(b); }); }
        const tabInitialized = {};
        function switchTab(id) { curTab = id; TABS.forEach(t => { document.getElementById('sec-' + t.id).classList.toggle('visible', t.id === id); document.getElementById('tab-' + t.id).classList.toggle('active', t.id === id); }); if (id === 'stats') refreshStats(); if (!tabInitialized[id]) { tabInitialized[id] = true; if (id === 'words') resetWordQuiz(); else if (id === 'tashkeel') resetTashkeelQuiz(); else if (id === 'syllables') resetSylQuiz(); else if (id === 'dictee') resetDicteeQuiz(); } saveState(); }

        // ===== GAMIFICATION =====
        let xp = 0, level = 1, streak = 0, lastDate = '';
        const XP_PER_LEVEL = 100;
        function addXP(n) { xp += n; while (xp >= level * XP_PER_LEVEL) { xp -= level * XP_PER_LEVEL; level++; showToast('ğŸ‰ Niveau ' + level + ' !', 'toast-level'); } showToast('+' + n + ' XP'); updateGamiBar(); saveState(); }
        function checkStreak() { const today = new Date().toISOString().slice(0, 10); if (lastDate !== today) { if (lastDate === new Date(Date.now() - 864e5).toISOString().slice(0, 10)) { streak++; showToast('ğŸ”¥ ' + streak + ' jours !', 'toast-streak'); } else if (lastDate !== '') { streak = 1; } else { streak = 1; } lastDate = today; saveState(); updateGamiBar(); } }
        function updateGamiBar() { document.getElementById('g-streak').textContent = streak; document.getElementById('g-level').textContent = level; document.getElementById('g-xp').textContent = xp; document.getElementById('g-xp-bar').style.width = ((xp / (level * XP_PER_LEVEL)) * 100) + '%'; }

        // ===== LOCALSTORAGE =====
        function saveState() { try { localStorage.setItem('arApp', JSON.stringify({ xp, level, streak, lastDate, curTab, lW: alphabetData.map(i => ({ w: i.weight, e: i.errors, s: i.successes, m: i.isMastered || false })), wW: wordsData.map(i => ({ w: i.weight, e: i.errors, s: i.successes, m: i.isMastered || false })), tW: tashkeelData.map(i => ({ w: i.weight, e: i.errors, s: i.successes, m: i.isMastered || false })), sW: sylData.map(i => ({ w: i.weight, e: i.errors, s: i.successes, m: i.isMastered || false })) })); } catch (e) { } }
        function loadState() { try { const d = JSON.parse(localStorage.getItem('arApp')); if (!d) return false; xp = d.xp || 0; level = d.level || 1; streak = d.streak || 0; lastDate = d.lastDate || ''; curTab = d.curTab || 'letters'; if (d.lW) d.lW.forEach((v, i) => { if (alphabetData[i]) { alphabetData[i].weight = v.w; alphabetData[i].errors = v.e; alphabetData[i].successes = v.s; alphabetData[i].isMastered = v.m; } }); if (d.wW) d.wW.forEach((v, i) => { if (wordsData[i]) { wordsData[i].weight = v.w; wordsData[i].errors = v.e; wordsData[i].successes = v.s; wordsData[i].isMastered = v.m; } }); if (d.tW) d.tW.forEach((v, i) => { if (tashkeelData[i]) { tashkeelData[i].weight = v.w; tashkeelData[i].errors = v.e; tashkeelData[i].successes = v.s; tashkeelData[i].isMastered = v.m; } }); if (d.sW) d.sW.forEach((v, i) => { if (sylData[i]) { sylData[i].weight = v.w; sylData[i].errors = v.e; sylData[i].successes = v.s; sylData[i].isMastered = v.m; } }); return true; } catch (e) { return false; } }

        // ===== SRS WEIGHTED RANDOM =====
        function srsSelect(pool) { const active = pool.filter(i => !i.isMastered); if (!active.length) return null; const totalW = active.reduce((s, i) => s + i.weight, 0); let r = Math.random() * totalW; for (const item of active) { r -= item.weight; if (r <= 0) return item; } return active[active.length - 1]; }
        function srsCorrect(item) { item.successes++; item.weight = Math.max(1, item.weight - 1); item.isMastered = true; }
        function srsWrong(item) { item.errors++; item.weight = Math.min(10, item.weight + 2); }

        // ===== BASE ALPHABET (for grid) =====
        const baseAlphabet = [
            { c: 'Ø§', n: 'Alif', aud: 'Ø£ÙÙ„ÙÙ', r: true, fm: ['Ø§', '', '', 'Ù€Ø§'] }, { c: 'Ø¨', n: 'Ba', aud: 'Ø¨ÙØ§Ø¡', r: false, fm: ['Ø¨', 'Ø¨Ù€', 'Ù€Ø¨Ù€', 'Ù€Ø¨'] },
            { c: 'Øª', n: 'Ta', aud: 'ØªÙØ§Ø¡', r: false, fm: ['Øª', 'ØªÙ€', 'Ù€ØªÙ€', 'Ù€Øª'] }, { c: 'Ø«', n: 'Tha', aud: 'Ø«ÙØ§Ø¡', r: false, fm: ['Ø«', 'Ø«Ù€', 'Ù€Ø«Ù€', 'Ù€Ø«'] },
            { c: 'Ø¬', n: 'Jim', aud: 'Ø¬ÙÙŠÙ…', r: false, fm: ['Ø¬', 'Ø¬Ù€', 'Ù€Ø¬Ù€', 'Ù€Ø¬'] }, { c: 'Ø­', n: 'Ha', aud: 'Ø­ÙØ§Ø¡', r: false, fm: ['Ø­', 'Ø­Ù€', 'Ù€Ø­Ù€', 'Ù€Ø­'] },
            { c: 'Ø®', n: 'Kha', aud: 'Ø®ÙØ§Ø¡', r: false, fm: ['Ø®', 'Ø®Ù€', 'Ù€Ø®Ù€', 'Ù€Ø®'] }, { c: 'Ø¯', n: 'Dal', aud: 'Ø¯ÙØ§Ù„', r: true, fm: ['Ø¯', '', '', 'Ù€Ø¯'] },
            { c: 'Ø°', n: 'Dhal', aud: 'Ø°ÙØ§Ù„', r: true, fm: ['Ø°', '', '', 'Ù€Ø°'] }, { c: 'Ø±', n: 'Ra', aud: 'Ø±ÙØ§Ø¡', r: true, fm: ['Ø±', '', '', 'Ù€Ø±'] },
            { c: 'Ø²', n: 'Zay', aud: 'Ø²ÙØ§ÙŠ', r: true, fm: ['Ø²', '', '', 'Ù€Ø²'] }, { c: 'Ø³', n: 'Sin', aud: 'Ø³ÙÙŠÙ†', r: false, fm: ['Ø³', 'Ø³Ù€', 'Ù€Ø³Ù€', 'Ù€Ø³'] },
            { c: 'Ø´', n: 'Shin', aud: 'Ø´ÙÙŠÙ†', r: false, fm: ['Ø´', 'Ø´Ù€', 'Ù€Ø´Ù€', 'Ù€Ø´'] }, { c: 'Øµ', n: 'Sad', aud: 'ØµÙØ§Ø¯', r: false, fm: ['Øµ', 'ØµÙ€', 'Ù€ØµÙ€', 'Ù€Øµ'] },
            { c: 'Ø¶', n: 'Dad', aud: 'Ø¶ÙØ§Ø¯', r: false, fm: ['Ø¶', 'Ø¶Ù€', 'Ù€Ø¶Ù€', 'Ù€Ø¶'] }, { c: 'Ø·', n: 'Ta', aud: 'Ø·ÙØ§Ø¡', r: false, fm: ['Ø·', 'Ø·Ù€', 'Ù€Ø·Ù€', 'Ù€Ø·'] },
            { c: 'Ø¸', n: 'Za', aud: 'Ø¸ÙØ§Ø¡', r: false, fm: ['Ø¸', 'Ø¸Ù€', 'Ù€Ø¸Ù€', 'Ù€Ø¸'] }, { c: 'Ø¹', n: 'Ayn', aud: 'Ø¹ÙÙŠÙ’Ù†', r: false, fm: ['Ø¹', 'Ø¹Ù€', 'Ù€Ø¹Ù€', 'Ù€Ø¹'] },
            { c: 'Øº', n: 'Ghayn', aud: 'ØºÙÙŠÙ’Ù†', r: false, fm: ['Øº', 'ØºÙ€', 'Ù€ØºÙ€', 'Ù€Øº'] }, { c: 'Ù', n: 'Fa', aud: 'ÙÙØ§Ø¡', r: false, fm: ['Ù', 'ÙÙ€', 'Ù€ÙÙ€', 'Ù€Ù'] },
            { c: 'Ù‚', n: 'Qaf', aud: 'Ù‚ÙØ§Ù', r: false, fm: ['Ù‚', 'Ù‚Ù€', 'Ù€Ù‚Ù€', 'Ù€Ù‚'] }, { c: 'Ùƒ', n: 'Kaf', aud: 'ÙƒÙØ§Ù', r: false, fm: ['Ùƒ', 'ÙƒÙ€', 'Ù€ÙƒÙ€', 'Ù€Ùƒ'] },
            { c: 'Ù„', n: 'Lam', aud: 'Ù„Ø§ÙÙ…', r: false, fm: ['Ù„', 'Ù„Ù€', 'Ù€Ù„Ù€', 'Ù€Ù„'] }, { c: 'Ù…', n: 'Mim', aud: 'Ù…ÙÙŠÙ…', r: false, fm: ['Ù…', 'Ù…Ù€', 'Ù€Ù…Ù€', 'Ù€Ù…'] },
            { c: 'Ù†', n: 'Nun', aud: 'Ù†ÙÙˆÙ†', r: false, fm: ['Ù†', 'Ù†Ù€', 'Ù€Ù†Ù€', 'Ù€Ù†'] }, { c: 'Ù‡', n: 'Ha', aud: 'Ù‡ÙØ§Ø¡', r: false, fm: ['Ù‡', 'Ù‡Ù€', 'Ù€Ù‡Ù€', 'Ù€Ù‡'] },
            { c: 'Ùˆ', n: 'Waw', aud: 'ÙˆÙØ§Ùˆ', r: true, fm: ['Ùˆ', '', '', 'Ù€Ùˆ'] }, { c: 'ÙŠ', n: 'Ya', aud: 'ÙŠÙØ§Ø¡', r: false, fm: ['ÙŠ', 'ÙŠÙ€', 'Ù€ÙŠÙ€', 'Ù€ÙŠ'] }
        ];

        // Helper
        function mkL(ch, ns, pos, aC, aW, fam, w, ph, tr) { return { char: ch, names: ns, pos: pos, audioChar: aC, audioWord: aW, family: fam, word: w, phonetic: ph, translation: tr, weight: 1, errors: 0, successes: 0, isMastered: false }; }

        // ===== LETTER QUIZ DATA =====
        const alphabetData = [
            // Famille 1: Ba Ta Tha
            mkL('Ø¨Ù€', ['ba', 'baa'], 'debut', 'Ø¨Ù', 'Ø¨ÙÙŠÙ’Øª', 'ba_ta_tha', '<span class="highlight">Ø¨ÙÙ€</span>ÙŠÙ’Øª', 'bayt', 'Maison'),
            mkL('Ù€Ø¨Ù€', ['ba', 'baa'], 'milieu', 'Ø¨Ù', 'ÙƒÙØ¨ÙÙŠØ±', 'ba_ta_tha', 'ÙƒÙÙ€<span class="highlight">Ù€Ø¨ÙÙ€</span>ÙŠÙ€Ø±', 'kabir', 'Grand'),
            mkL('Ù€Ø¨', ['ba', 'baa'], 'fin', 'Ø¨Ù', 'ÙƒÙØªÙØ§Ø¨', 'ba_ta_tha', 'ÙƒÙØªÙØ§<span class="highlight">Ù€Ø¨</span>', 'kitab', 'Livre'),
            mkL('Ø¨', ['ba', 'baa'], 'isolee', 'Ø¨Ù', 'Ø¨ÙØ§Ø¨', 'ba_ta_tha', 'Ø¨ÙØ§<span class="highlight">Ø¨</span>', 'bab', 'Porte'),
            mkL('ØªÙ€', ['ta', 'taa'], 'debut', 'ØªÙ', 'ØªÙÙÙÙ‘Ø§Ø­ÙØ©', 'ba_ta_tha', '<span class="highlight">ØªÙÙ€</span>ÙÙÙ‘Ø§Ø­ÙØ©', 'tuffaha', 'Pomme'),
            mkL('Ù€ØªÙ€', ['ta', 'taa'], 'milieu', 'ØªÙ', 'Ù…ÙÙƒÙ’ØªÙØ¨', 'ba_ta_tha', 'Ù…ÙÙƒÙ’Ù€<span class="highlight">Ù€ØªÙÙ€</span>Ø¨', 'maktab', 'Bureau'),
            mkL('Ù€Øª', ['ta', 'taa'], 'fin', 'ØªÙ', 'Ø¨ÙÙŠÙ’Øª', 'ba_ta_tha', 'Ø¨ÙÙŠÙ’Ù€<span class="highlight">Ù€Øª</span>', 'bayt', 'Maison'),
            mkL('Ø«Ù€', ['tha', 'thaa'], 'debut', 'Ø«Ù', 'Ø«ÙØ¹Ù’Ù„ÙØ¨', 'ba_ta_tha', '<span class="highlight">Ø«ÙÙ€</span>Ø¹Ù’Ù„ÙØ¨', 'thalab', 'Renard'),
            mkL('Ù€Ø«Ù€', ['tha', 'thaa'], 'milieu', 'Ø«Ù', 'Ù…ÙØ«ÙÙ„ÙÙ‘Ø«', 'ba_ta_tha', 'Ù…ÙÙ€<span class="highlight">Ù€Ø«ÙÙ€</span>Ù„ÙÙ‘Ø«', 'muthallath', 'Triangle'),
            mkL('Ù€Ø«', ['tha', 'thaa'], 'fin', 'Ø«Ù', 'Ù…ÙØ«ÙÙ„ÙÙ‘Ø«', 'ba_ta_tha', 'Ù…ÙØ«ÙÙ„ÙÙ‘Ù€<span class="highlight">Ù€Ø«</span>', 'muthallath', 'Triangle'),
            // Famille 2: Jim Ha Kha
            mkL('Ø¬Ù€', ['jim', 'jeem', 'djim'], 'debut', 'Ø¬Ù', 'Ø¬ÙÙ…ÙÙ„', 'jim_ha_kha', '<span class="highlight">Ø¬ÙÙ€</span>Ù…ÙÙ„', 'jamal', 'Chameau'),
            mkL('Ù€Ø¬Ù€', ['jim', 'jeem', 'djim'], 'milieu', 'Ø¬Ù', 'Ù†ÙØ¬Ù’Ù…', 'jim_ha_kha', 'Ù†ÙÙ€<span class="highlight">Ù€Ø¬Ù’Ù€</span>Ù…', 'najm', 'Ã‰toile'),
            mkL('Ù€Ø¬', ['jim', 'jeem', 'djim'], 'fin', 'Ø¬Ù', 'Ø«ÙÙ„Ù’Ø¬', 'jim_ha_kha', 'Ø«ÙÙ„Ù’Ù€<span class="highlight">Ù€Ø¬</span>', 'thalj', 'Neige'),
            mkL('Ø­Ù€', ['ha', 'haa', '7a'], 'debut', 'Ø­Ù', 'Ø­ÙÙ„ÙÙŠØ¨', 'jim_ha_kha', '<span class="highlight">Ø­ÙÙ€</span>Ù„ÙÙŠØ¨', 'halib', 'Lait'),
            mkL('Ù€Ø­Ù€', ['ha', 'haa', '7a'], 'milieu', 'Ø­Ù', 'Ù„ÙØ­Ù’Ù…', 'jim_ha_kha', 'Ù„ÙÙ€<span class="highlight">Ù€Ø­Ù’Ù€</span>Ù…', 'lahm', 'Viande'),
            mkL('Ù€Ø­', ['ha', 'haa', '7a'], 'fin', 'Ø­Ù', 'ØµÙØ¨ÙØ§Ø­', 'jim_ha_kha', 'ØµÙØ¨ÙØ§<span class="highlight">Ù€Ø­</span>', 'sabah', 'Matin'),
            mkL('Ø®Ù€', ['kha', 'khaa'], 'debut', 'Ø®Ù', 'Ø®ÙØ¨Ù’Ø²', 'jim_ha_kha', '<span class="highlight">Ø®ÙÙ€</span>Ø¨Ù’Ø²', 'khubz', 'Pain'),
            mkL('Ù€Ø®Ù€', ['kha', 'khaa'], 'milieu', 'Ø®Ù', 'Ù…ÙØ®Ù’ØªÙÙ„ÙÙ', 'jim_ha_kha', 'Ù…ÙÙ€<span class="highlight">Ù€Ø®Ù’Ù€</span>ØªÙÙ„ÙÙ', 'mukhtalif', 'DiffÃ©rent'),
            mkL('Ù€Ø®', ['kha', 'khaa'], 'fin', 'Ø®Ù', 'Ù…ÙØ·Ù’Ø¨ÙØ®', 'jim_ha_kha', 'Ù…ÙØ·Ù’Ø¨ÙÙ€<span class="highlight">Ù€Ø®</span>', 'matbakh', 'Cuisine'),
            // Famille 3: Dal Dhal Ra Zay (rebelles)
            mkL('Ø¯', ['dal', 'daal'], 'isolee', 'Ø¯Ù', 'Ø¯ÙÙŠÙƒ', 'dal_dhal_ra_zay', '<span class="highlight">Ø¯Ù</span>ÙŠÙƒ', 'dik', 'Coq'),
            mkL('Ù€Ø¯', ['dal', 'daal'], 'fin', 'Ø¯Ù', 'ÙˆÙÙ„ÙØ¯', 'dal_dhal_ra_zay', 'ÙˆÙÙ„ÙÙ€<span class="highlight">Ù€Ø¯</span>', 'walad', 'GarÃ§on'),
            mkL('Ø°', ['dhal', 'dhaal'], 'isolee', 'Ø°Ù', 'Ø°ÙÙ‡ÙØ¨', 'dal_dhal_ra_zay', '<span class="highlight">Ø°Ù</span>Ù‡ÙØ¨', 'dhahab', 'Or'),
            mkL('Ù€Ø°', ['dhal', 'dhaal'], 'fin', 'Ø°Ù', 'ØªÙÙ„Ù’Ù…ÙÙŠØ°', 'dal_dhal_ra_zay', 'ØªÙÙ„Ù’Ù…ÙÙŠÙ€<span class="highlight">Ù€Ø°</span>', 'tilmidh', 'Ã‰lÃ¨ve'),
            mkL('Ø±', ['ra', 'raa'], 'isolee', 'Ø±Ù', 'Ø±ÙØ¬ÙÙ„', 'dal_dhal_ra_zay', '<span class="highlight">Ø±Ù</span>Ø¬ÙÙ„', 'rajul', 'Homme'),
            mkL('Ù€Ø±', ['ra', 'raa'], 'fin', 'Ø±Ù', 'Ù†ÙÙ…ÙØ±', 'dal_dhal_ra_zay', 'Ù†ÙÙ…ÙÙ€<span class="highlight">Ù€Ø±</span>', 'namir', 'Tigre'),
            mkL('Ø²', ['zay', 'zaay'], 'isolee', 'Ø²Ù', 'Ø²ÙÙ‡Ù’Ø±ÙØ©', 'dal_dhal_ra_zay', '<span class="highlight">Ø²Ù</span>Ù‡Ù’Ø±ÙØ©', 'zahra', 'Fleur'),
            mkL('Ù€Ø²', ['zay', 'zaay'], 'fin', 'Ø²Ù', 'Ø®ÙØ¨Ù’Ø²', 'dal_dhal_ra_zay', 'Ø®ÙØ¨Ù’Ù€<span class="highlight">Ù€Ø²</span>', 'khubz', 'Pain'),
            // Famille 4: Sin Shin
            mkL('Ø³Ù€', ['sin', 'seen'], 'debut', 'Ø³Ù', 'Ø³ÙÙ…ÙÙƒÙØ©', 'sin_shin', '<span class="highlight">Ø³ÙÙ€</span>Ù…ÙÙƒÙØ©', 'samaka', 'Poisson'),
            mkL('Ù€Ø³Ù€', ['sin', 'seen'], 'milieu', 'Ø³Ù', 'Ù…ÙØ³Ù’Ø¬ÙØ¯', 'sin_shin', 'Ù…ÙÙ€<span class="highlight">Ù€Ø³Ù’Ù€</span>Ø¬ÙØ¯', 'masjid', 'MosquÃ©e'),
            mkL('Ù€Ø³', ['sin', 'seen'], 'fin', 'Ø³Ù', 'Ø´ÙÙ…Ù’Ø³', 'sin_shin', 'Ø´ÙÙ…Ù’Ù€<span class="highlight">Ù€Ø³</span>', 'shams', 'Soleil'),
            mkL('Ø´Ù€', ['shin', 'sheen', 'chin'], 'debut', 'Ø´Ù', 'Ø´ÙÙ…Ù’Ø³', 'sin_shin', '<span class="highlight">Ø´ÙÙ€</span>Ù…Ù’Ø³', 'shams', 'Soleil'),
            mkL('Ù€Ø´Ù€', ['shin', 'sheen', 'chin'], 'milieu', 'Ø´Ù', 'Ù…ÙØ´Ù’Ø±ÙÙˆØ¨', 'sin_shin', 'Ù…ÙÙ€<span class="highlight">Ù€Ø´Ù’Ù€</span>Ø±ÙÙˆØ¨', 'mashroub', 'Boisson'),
            mkL('Ù€Ø´', ['shin', 'sheen', 'chin'], 'fin', 'Ø´Ù', 'Ø¹ÙØ·ÙØ´', 'sin_shin', 'Ø¹ÙØ·ÙÙ€<span class="highlight">Ù€Ø´</span>', 'atash', 'Soif'),
            // Famille 5: Sad Dad
            mkL('ØµÙ€', ['sad', 'saad'], 'debut', 'ØµÙ', 'ØµÙØ¨ÙØ§Ø­', 'sad_dad', '<span class="highlight">ØµÙÙ€</span>Ø¨ÙØ§Ø­', 'sabah', 'Matin'),
            mkL('Ù€ØµÙ€', ['sad', 'saad'], 'milieu', 'ØµÙ', 'Ø­ÙØµÙØ§Ù†', 'sad_dad', 'Ø­ÙÙ€<span class="highlight">Ù€ØµÙÙ€</span>Ø§Ù†', 'hisan', 'Cheval'),
            mkL('Ø¶Ù€', ['dad', 'daad'], 'debut', 'Ø¶Ù', 'Ø¶ÙÙˆÙ’Ø¡', 'sad_dad', '<span class="highlight">Ø¶ÙÙ€</span>ÙˆÙ’Ø¡', 'daw', 'LumiÃ¨re'),
            mkL('Ù€Ø¶Ù€', ['dad', 'daad'], 'milieu', 'Ø¶Ù', 'Ù…ÙØ¶Ù’Ø±ÙØ¨', 'sad_dad', 'Ù…ÙÙ€<span class="highlight">Ù€Ø¶Ù’Ù€</span>Ø±ÙØ¨', 'midrab', 'Raquette'),
            // Famille 6: Ta Za (emphatiques)
            mkL('Ø·Ù€', ['ta', 'taa'], 'debut', 'Ø·Ù', 'Ø·ÙØ§ÙˆÙÙ„ÙØ©', 'ta_za', '<span class="highlight">Ø·ÙÙ€</span>Ø§ÙˆÙÙ„ÙØ©', 'tawila', 'Table'),
            mkL('Ù€Ø·Ù€', ['ta', 'taa'], 'milieu', 'Ø·Ù', 'Ù…ÙØ·Ù’Ø¨ÙØ®', 'ta_za', 'Ù…ÙÙ€<span class="highlight">Ù€Ø·Ù’Ù€</span>Ø¨ÙØ®', 'matbakh', 'Cuisine'),
            mkL('Ø¸Ù€', ['za', 'zaa'], 'debut', 'Ø¸Ù', 'Ø¸ÙÙ‡Ù’Ø±', 'ta_za', '<span class="highlight">Ø¸ÙÙ€</span>Ù‡Ù’Ø±', 'zahr', 'Dos'),
            mkL('Ù€Ø¸Ù€', ['za', 'zaa'], 'milieu', 'Ø¸Ù', 'Ù†ÙØ¸ÙØ±', 'ta_za', 'Ù†ÙÙ€<span class="highlight">Ù€Ø¸ÙÙ€</span>Ø±', 'nazar', 'Vue'),
            // Famille 7: Ayn Ghayn
            mkL('Ø¹Ù€', ['ayn', 'ain', '3ayn'], 'debut', 'Ø¹Ù', 'Ø¹ÙÙŠÙ’Ù†', 'ayn_ghayn', '<span class="highlight">Ø¹ÙÙ€</span>ÙŠÙ’Ù†', 'ayn', 'Oeil'),
            mkL('Ù€Ø¹Ù€', ['ayn', 'ain', '3ayn'], 'milieu', 'Ø¹Ù', 'Ù…ÙØ¹Ù’Ù†ÙÙ‰', 'ayn_ghayn', 'Ù…ÙÙ€<span class="highlight">Ù€Ø¹Ù’Ù€</span>Ù†ÙÙ‰', 'maana', 'Sens'),
            mkL('Ù€Ø¹', ['ayn', 'ain', '3ayn'], 'fin', 'Ø¹Ù', 'Ø´ÙØ¬ÙØ§Ø¹', 'ayn_ghayn', 'Ø´ÙØ¬ÙØ§<span class="highlight">Ù€Ø¹</span>', 'shuja', 'Courageux'),
            mkL('ØºÙ€', ['ghayn', 'ghain'], 'debut', 'ØºÙ', 'ØºÙØ±Ù’ÙÙØ©', 'ayn_ghayn', '<span class="highlight">ØºÙÙ€</span>Ø±Ù’ÙÙØ©', 'ghurfa', 'Chambre'),
            mkL('Ù€ØºÙ€', ['ghayn', 'ghain'], 'milieu', 'ØºÙ', 'ØµÙØºÙÙŠØ±', 'ayn_ghayn', 'ØµÙÙ€<span class="highlight">Ù€ØºÙÙ€</span>Ù€ÙŠÙ€Ø±', 'saghir', 'Petit'),
            // Famille 8: Fa Qaf
            mkL('ÙÙ€', ['fa', 'faa'], 'debut', 'ÙÙ', 'ÙÙÙ…', 'fa_qaf', '<span class="highlight">ÙÙÙ€</span>Ù…', 'fam', 'Bouche'),
            mkL('Ù€ÙÙ€', ['fa', 'faa'], 'milieu', 'ÙÙ', 'Ù…ÙÙÙ’ØªÙØ§Ø­', 'fa_qaf', 'Ù…ÙÙ€<span class="highlight">Ù€ÙÙ’Ù€</span>ØªÙØ§Ø­', 'miftah', 'ClÃ©'),
            mkL('Ù‚Ù€', ['qaf', 'qaaf'], 'debut', 'Ù‚Ù', 'Ù‚ÙÙ„ÙÙ…', 'fa_qaf', '<span class="highlight">Ù‚ÙÙ€</span>Ù„ÙÙ…', 'qalam', 'Stylo'),
            mkL('Ù€Ù‚Ù€', ['qaf', 'qaaf'], 'milieu', 'Ù‚Ù', 'Ø¨ÙÙ‚ÙØ±ÙØ©', 'fa_qaf', 'Ø¨ÙÙ€<span class="highlight">Ù€Ù‚ÙÙ€</span>Ø±ÙØ©', 'baqara', 'Vache'),
            // Famille 9: Kaf Lam Mim Nun
            mkL('ÙƒÙ€', ['kaf', 'kaaf'], 'debut', 'ÙƒÙ', 'ÙƒÙØªÙØ§Ø¨', 'kaf_lam_mim_nun', '<span class="highlight">ÙƒÙÙ€</span>ØªÙØ§Ø¨', 'kitab', 'Livre'),
            mkL('Ù€ÙƒÙ€', ['kaf', 'kaaf'], 'milieu', 'ÙƒÙ', 'Ù…ÙÙƒÙ’ØªÙØ¨', 'kaf_lam_mim_nun', 'Ù…ÙÙ€<span class="highlight">Ù€ÙƒÙ’Ù€</span>ØªÙØ¨', 'maktab', 'Bureau'),
            mkL('Ù„Ù€', ['lam', 'laam'], 'debut', 'Ù„Ù', 'Ù„ÙØ­Ù’Ù…', 'kaf_lam_mim_nun', '<span class="highlight">Ù„ÙÙ€</span>Ø­Ù’Ù…', 'lahm', 'Viande'),
            mkL('Ù€Ù„Ù€', ['lam', 'laam'], 'milieu', 'Ù„Ù', 'Ù‚ÙÙ„ÙÙ…', 'kaf_lam_mim_nun', 'Ù‚ÙÙ€<span class="highlight">Ù€Ù„ÙÙ€</span>Ù…', 'qalam', 'Stylo'),
            mkL('Ù…Ù€', ['mim', 'meem'], 'debut', 'Ù…Ù', 'Ù…ÙØ§Ø¡', 'kaf_lam_mim_nun', '<span class="highlight">Ù…ÙÙ€</span>Ø§Ø¡', 'ma', 'Eau'),
            mkL('Ù€Ù…Ù€', ['mim', 'meem'], 'milieu', 'Ù…Ù', 'Ø´ÙÙ…Ù’Ø³', 'kaf_lam_mim_nun', 'Ø´ÙÙ€<span class="highlight">Ù€Ù…Ù’Ù€</span>Ø³', 'shams', 'Soleil'),
            mkL('Ù€Ù…', ['mim', 'meem'], 'fin', 'Ù…Ù', 'Ù‚ÙÙ„ÙÙ…', 'kaf_lam_mim_nun', 'Ù‚ÙÙ„ÙÙ€<span class="highlight">Ù€Ù…</span>', 'qalam', 'Stylo'),
            mkL('Ù†Ù€', ['nun', 'noon'], 'debut', 'Ù†Ù', 'Ù†ÙØ§Ø±', 'kaf_lam_mim_nun', '<span class="highlight">Ù†ÙÙ€</span>Ø§Ø±', 'nar', 'Feu'),
            mkL('Ù€Ù†Ù€', ['nun', 'noon'], 'milieu', 'Ù†Ù', 'Ø¨ÙÙ†Ù’Øª', 'kaf_lam_mim_nun', 'Ø¨ÙÙ€<span class="highlight">Ù€Ù†Ù’Ù€</span>Øª', 'bint', 'Fille'),
            mkL('Ù€Ù†', ['nun', 'noon'], 'fin', 'Ù†Ù', 'Ø¹ÙÙŠÙ’Ù†', 'kaf_lam_mim_nun', 'Ø¹ÙÙŠÙ’Ù€<span class="highlight">Ù€Ù†</span>', 'ayn', 'Oeil'),
            // Famille 10: Ha Waw Ya
            mkL('Ù‡Ù€', ['ha', 'haa'], 'debut', 'Ù‡Ù', 'Ù‡ÙÙˆÙØ§Ø¡', 'ha_waw_ya', '<span class="highlight">Ù‡ÙÙ€</span>ÙˆÙØ§Ø¡', 'hawa', 'Air'),
            mkL('Ù€Ù‡Ù€', ['ha', 'haa'], 'milieu', 'Ù‡Ù', 'Ù†ÙÙ‡Ù’Ø±', 'ha_waw_ya', 'Ù†ÙÙ€<span class="highlight">Ù€Ù‡Ù’Ù€</span>Ø±', 'nahr', 'RiviÃ¨re'),
            mkL('Ù€Ù‡', ['ha', 'haa'], 'fin', 'Ù‡Ù', 'ÙˆÙØ¬Ù’Ù‡', 'ha_waw_ya', 'ÙˆÙØ¬Ù’Ù€<span class="highlight">Ù€Ù‡</span>', 'wajh', 'Visage'),
            mkL('Ùˆ', ['waw', 'waaw'], 'isolee', 'ÙˆÙ', 'ÙˆÙÙ„ÙØ¯', 'ha_waw_ya', '<span class="highlight">ÙˆÙ</span>Ù„ÙØ¯', 'walad', 'GarÃ§on'),
            mkL('Ù€Ùˆ', ['waw', 'waaw'], 'fin', 'ÙˆÙ', 'Ø¶ÙÙˆÙ’Ø¡', 'ha_waw_ya', 'Ø¶ÙÙˆÙ’<span class="highlight">Ù€Ùˆ</span>', 'daw', 'LumiÃ¨re'),
            mkL('ÙŠÙ€', ['ya', 'yaa'], 'debut', 'ÙŠÙ', 'ÙŠÙØ¯', 'ha_waw_ya', '<span class="highlight">ÙŠÙÙ€</span>Ø¯', 'yad', 'Main'),
            mkL('Ù€ÙŠÙ€', ['ya', 'yaa'], 'milieu', 'ÙŠÙ', 'Ø¨ÙÙŠÙ’Øª', 'ha_waw_ya', 'Ø¨ÙÙ€<span class="highlight">Ù€ÙŠÙ’Ù€</span>Øª', 'bayt', 'Maison'),
            mkL('Ù€ÙŠ', ['ya', 'yaa'], 'fin', 'ÙŠÙ', 'ÙƒÙØ±Ù’Ø³ÙÙŠÙ‘', 'ha_waw_ya', 'ÙƒÙØ±Ù’Ø³ÙÙ€<span class="highlight">Ù€ÙŠÙ‘</span>', 'kursi', 'Chaise')
        ];

        // Family filter options
        const FAMILIES = [{ v: 'all', l: 'Toutes les lettres (MÃ©lange)' }, { v: 'ba_ta_tha', l: 'Famille 1 : Ba, Ta, Tha (Ø¨ Øª Ø«)' }, { v: 'jim_ha_kha', l: 'Famille 2 : Jim, Ha, Kha (Ø¬ Ø­ Ø®)' }, { v: 'dal_dhal_ra_zay', l: 'Famille 3 : Dal, Dhal, Ra, Zay (Ø¯ Ø° Ø± Ø²)' }, { v: 'sin_shin', l: 'Famille 4 : Sin, Shin (Ø³ Ø´)' }, { v: 'sad_dad', l: 'Famille 5 : Sad, Dad (Øµ Ø¶)' }, { v: 'ta_za', l: 'Famille 6 : Ta, Za (Ø· Ø¸)' }, { v: 'ayn_ghayn', l: 'Famille 7 : Ayn, Ghayn (Ø¹ Øº)' }, { v: 'fa_qaf', l: 'Famille 8 : Fa, Qaf (Ù Ù‚)' }, { v: 'kaf_lam_mim_nun', l: 'Famille 9 : Kaf, Lam, Mim, Nun (Ùƒ Ù„ Ù… Ù†)' }, { v: 'ha_waw_ya', l: 'Famille 10 : Ha, Waw, Ya (Ù‡Ù€ Ùˆ ÙŠ)' }];
        function initFamilyFilter() { const s = document.getElementById('family-filter'); FAMILIES.forEach(f => { const o = document.createElement('option'); o.value = f.v; o.textContent = f.l; s.appendChild(o); }); }

        // Helper for words
        function mkW(ar, ph, tr, bd) { return { arabic: ar, acceptedPhonetics: ph, translation: tr, breakdown: bd, weight: 1, errors: 0, successes: 0, isMastered: false }; }
        function mkB(c, n, p) { return { char: c, name: n, pos: p }; }

        // ===== WORDS DATA =====
        const wordsData = [
            mkW('Ø¨ÙÙŠÙ’Øª', ['bayt', 'bait'], 'Maison', [mkB('Ø¨ÙÙ€', 'Ba', 'DÃ©but'), mkB('Ù€ÙŠÙ’Ù€', 'Ya', 'Milieu'), mkB('Ù€Øª', 'Ta', 'Fin')]),
            mkW('Ø¨ÙØ§Ø¨', ['bab', 'baab'], 'Porte', [mkB('Ø¨ÙÙ€', 'Ba', 'DÃ©but'), mkB('Ø§', 'Alif', 'Rebelle'), mkB('Ø¨', 'Ba', 'IsolÃ©e')]),
            mkW('ÙƒÙØªÙØ§Ø¨', ['kitab'], 'Livre', [mkB('ÙƒÙÙ€', 'Kaf', 'DÃ©but'), mkB('Ù€ØªÙÙ€', 'Ta', 'Milieu'), mkB('Ø§', 'Alif', 'Rebelle'), mkB('Ø¨', 'Ba', 'IsolÃ©e')]),
            mkW('Ù‚ÙÙ„ÙÙ…', ['qalam', 'kalam'], 'Stylo', [mkB('Ù‚ÙÙ€', 'Qaf', 'DÃ©but'), mkB('Ù€Ù„ÙÙ€', 'Lam', 'Milieu'), mkB('Ù€Ù…', 'Mim', 'Fin')]),
            mkW('Ù…ÙÙƒÙ’ØªÙØ¨', ['maktab'], 'Bureau', [mkB('Ù…ÙÙ€', 'Mim', 'DÃ©but'), mkB('Ù€ÙƒÙ’Ù€', 'Kaf', 'Milieu'), mkB('Ù€ØªÙÙ€', 'Ta', 'Milieu'), mkB('Ù€Ø¨', 'Ba', 'Fin')]),
            mkW('Ø£ÙØ¨', ['ab'], 'PÃ¨re', [mkB('Ø£Ù', 'Alif', 'Rebelle'), mkB('Ø¨', 'Ba', 'IsolÃ©e')]),
            mkW('Ø£ÙÙ…Ù‘', ['um', 'oum', 'umm'], 'MÃ¨re', [mkB('Ø£Ù', 'Alif', 'Rebelle'), mkB('Ù…Ù‘', 'Mim', 'IsolÃ©e')]),
            mkW('Ø£ÙØ®', ['akh'], 'FrÃ¨re', [mkB('Ø£Ù', 'Alif', 'Rebelle'), mkB('Ø®', 'Kha', 'IsolÃ©e')]),
            mkW('ÙˆÙÙ„ÙØ¯', ['walad'], 'GarÃ§on', [mkB('ÙˆÙ', 'Waw', 'Rebelle'), mkB('Ù„ÙÙ€', 'Lam', 'DÃ©but'), mkB('Ù€Ø¯', 'Dal', 'Fin')]),
            mkW('Ø¨ÙÙ†Ù’Øª', ['bint'], 'Fille', [mkB('Ø¨ÙÙ€', 'Ba', 'DÃ©but'), mkB('Ù€Ù†Ù’Ù€', 'Nun', 'Milieu'), mkB('Ù€Øª', 'Ta', 'Fin')]),
            mkW('ÙƒÙÙ„Ù’Ø¨', ['kalb'], 'Chien', [mkB('ÙƒÙÙ€', 'Kaf', 'DÃ©but'), mkB('Ù€Ù„Ù’Ù€', 'Lam', 'Milieu'), mkB('Ù€Ø¨', 'Ba', 'Fin')]),
            mkW('Ø¬ÙÙ…ÙÙ„', ['jamal', 'djamal'], 'Chameau', [mkB('Ø¬ÙÙ€', 'Jim', 'DÃ©but'), mkB('Ù€Ù…ÙÙ€', 'Mim', 'Milieu'), mkB('Ù€Ù„', 'Lam', 'Fin')]),
            mkW('Ù†ÙÙ…ÙØ±', ['namir'], 'Tigre', [mkB('Ù†ÙÙ€', 'Nun', 'DÃ©but'), mkB('Ù€Ù…ÙÙ€', 'Mim', 'Milieu'), mkB('Ù€Ø±', 'Ra', 'Fin')]),
            mkW('Ø³ÙÙ…ÙÙƒÙØ©', ['samaka'], 'Poisson', [mkB('Ø³ÙÙ€', 'Sin', 'DÃ©but'), mkB('Ù€Ù…ÙÙ€', 'Mim', 'Milieu'), mkB('Ù€ÙƒÙÙ€', 'Kaf', 'Milieu'), mkB('Ù€Ø©', 'Ta marb.', 'Fin')]),
            mkW('Ø¨ÙÙ‚ÙØ±ÙØ©', ['baqara', 'bakara'], 'Vache', [mkB('Ø¨ÙÙ€', 'Ba', 'DÃ©but'), mkB('Ù€Ù‚ÙÙ€', 'Qaf', 'Milieu'), mkB('Ù€Ø±Ù', 'Ra', 'Fin'), mkB('Ø©', 'Ta marb.', 'IsolÃ©e')]),
            mkW('Ø­ÙØµÙØ§Ù†', ['hisan', '7isan'], 'Cheval', [mkB('Ø­ÙÙ€', 'Ha', 'DÃ©but'), mkB('Ù€ØµÙÙ€', 'Sad', 'Milieu'), mkB('Ø§', 'Alif', 'Rebelle'), mkB('Ù†', 'Nun', 'IsolÃ©e')]),
            mkW('Ù…ÙØ§Ø¡', ['ma', 'maa'], 'Eau', [mkB('Ù…ÙÙ€', 'Mim', 'DÃ©but'), mkB('Ø§', 'Alif', 'Rebelle'), mkB('Ø¡', 'Hamza', 'IsolÃ©e')]),
            mkW('Ù†ÙØ§Ø±', ['nar', 'naar'], 'Feu', [mkB('Ù†ÙÙ€', 'Nun', 'DÃ©but'), mkB('Ø§', 'Alif', 'Rebelle'), mkB('Ø±', 'Ra', 'IsolÃ©e')]),
            mkW('Ø´ÙÙ…Ù’Ø³', ['shams', 'chams'], 'Soleil', [mkB('Ø´ÙÙ€', 'Shin', 'DÃ©but'), mkB('Ù€Ù…Ù’Ù€', 'Mim', 'Milieu'), mkB('Ù€Ø³', 'Sin', 'Fin')]),
            mkW('Ù‚ÙÙ…ÙØ±', ['qamar', 'kamar'], 'Lune', [mkB('Ù‚ÙÙ€', 'Qaf', 'DÃ©but'), mkB('Ù€Ù…ÙÙ€', 'Mim', 'Milieu'), mkB('Ù€Ø±', 'Ra', 'Fin')]),
            mkW('Ø¬ÙØ¨ÙÙ„', ['jabal', 'djabal'], 'Montagne', [mkB('Ø¬ÙÙ€', 'Jim', 'DÃ©but'), mkB('Ù€Ø¨ÙÙ€', 'Ba', 'Milieu'), mkB('Ù€Ù„', 'Lam', 'Fin')]),
            mkW('Ø®ÙØ¨Ù’Ø²', ['khubz', 'khoubz'], 'Pain', [mkB('Ø®ÙÙ€', 'Kha', 'DÃ©but'), mkB('Ù€Ø¨Ù’Ù€', 'Ba', 'Milieu'), mkB('Ø²', 'Zay', 'Fin')]),
            mkW('Ø­ÙÙ„ÙÙŠØ¨', ['halib', 'haleeb', '7alib'], 'Lait', [mkB('Ø­ÙÙ€', 'Ha', 'DÃ©but'), mkB('Ù€Ù„ÙÙ€', 'Lam', 'Milieu'), mkB('Ù€ÙŠÙ€', 'Ya', 'Milieu'), mkB('Ù€Ø¨', 'Ba', 'Fin')]),
            mkW('Ø¹ÙÙŠÙ’Ù†', ['ayn', 'ain', '3ayn'], 'Oeil', [mkB('Ø¹ÙÙ€', 'Ayn', 'DÃ©but'), mkB('Ù€ÙŠÙ’Ù€', 'Ya', 'Milieu'), mkB('Ù€Ù†', 'Nun', 'Fin')]),
            mkW('ÙÙÙ…', ['fam'], 'Bouche', [mkB('ÙÙÙ€', 'Fa', 'DÃ©but'), mkB('Ù€Ù…', 'Mim', 'Fin')]),
            mkW('ÙŠÙØ¯', ['yad'], 'Main', [mkB('ÙŠÙÙ€', 'Ya', 'DÃ©but'), mkB('Ø¯', 'Dal', 'Fin')]),
            mkW('ÙƒÙØ±Ù’Ø³ÙÙŠÙ‘', ['kursi', 'koursi'], 'Chaise', [mkB('ÙƒÙÙ€', 'Kaf', 'DÃ©but'), mkB('Ù€Ø±Ù’', 'Ra', 'Fin'), mkB('Ø³ÙÙ€', 'Sin', 'DÃ©but'), mkB('Ù€ÙŠÙ‘', 'Ya', 'Fin')]),
            mkW('Ø³ÙÙŠÙÙ‘Ø§Ø±ÙØ©', ['sayara', 'sayyara'], 'Voiture', [mkB('Ø³ÙÙ€', 'Sin', 'DÃ©but'), mkB('Ù€ÙŠÙÙ‘Ù€', 'Ya', 'Milieu'), mkB('Ø§', 'Alif', 'Rebelle'), mkB('Ø±Ù', 'Ra', 'Rebelle'), mkB('Ø©', 'Ta marb.', 'IsolÃ©e')]),
            mkW('ÙƒÙØ¨ÙÙŠØ±', ['kabir', 'kabeer'], 'Grand', [mkB('ÙƒÙÙ€', 'Kaf', 'DÃ©but'), mkB('Ù€Ø¨ÙÙ€', 'Ba', 'Milieu'), mkB('Ù€ÙŠÙ€', 'Ya', 'Milieu'), mkB('Ù€Ø±', 'Ra', 'Fin')]),
            mkW('ØµÙØºÙÙŠØ±', ['saghir', 'sagheer'], 'Petit', [mkB('ØµÙÙ€', 'Sad', 'DÃ©but'), mkB('Ù€ØºÙÙ€', 'Ghayn', 'Milieu'), mkB('Ù€ÙŠÙ€', 'Ya', 'Milieu'), mkB('Ù€Ø±', 'Ra', 'Fin')]),
            // Nouveaux mots
            mkW('Ø³ÙÙ„ÙØ§Ù…', ['salam', 'salaam'], 'Paix', [mkB('Ø³ÙÙ€', 'Sin', 'DÃ©but'), mkB('Ù€Ù„ÙÙ€', 'Lam', 'Milieu'), mkB('Ø§', 'Alif', 'Rebelle'), mkB('Ù…', 'Mim', 'IsolÃ©e')]),
            mkW('ØµÙØ¨ÙØ§Ø­', ['sabah', 'sabaa7'], 'Matin', [mkB('ØµÙÙ€', 'Sad', 'DÃ©but'), mkB('Ù€Ø¨ÙÙ€', 'Ba', 'Milieu'), mkB('Ø§', 'Alif', 'Rebelle'), mkB('Ø­', 'Ha', 'IsolÃ©e')]),
            mkW('Ù…ÙØ³ÙØ§Ø¡', ['masa', 'masaa'], 'Soir', [mkB('Ù…ÙÙ€', 'Mim', 'DÃ©but'), mkB('Ù€Ø³ÙÙ€', 'Sin', 'Milieu'), mkB('Ø§', 'Alif', 'Rebelle'), mkB('Ø¡', 'Hamza', 'IsolÃ©e')]),
            mkW('Ù…ÙØ¯Ù’Ø±ÙØ³ÙØ©', ['madrasa'], 'Ã‰cole', [mkB('Ù…ÙÙ€', 'Mim', 'DÃ©but'), mkB('Ù€Ø¯Ù’', 'Dal', 'Fin'), mkB('Ø±Ù', 'Ra', 'Rebelle'), mkB('Ø³ÙÙ€', 'Sin', 'DÃ©but'), mkB('Ù€Ø©', 'Ta marb.', 'Fin')]),
            mkW('Ù…ÙØ³Ù’Ø¬ÙØ¯', ['masjid'], 'MosquÃ©e', [mkB('Ù…ÙÙ€', 'Mim', 'DÃ©but'), mkB('Ù€Ø³Ù’Ù€', 'Sin', 'Milieu'), mkB('Ù€Ø¬ÙÙ€', 'Jim', 'Milieu'), mkB('Ù€Ø¯', 'Dal', 'Fin')]),
            mkW('Ù†ÙØ¬Ù’Ù…', ['najm'], 'Ã‰toile', [mkB('Ù†ÙÙ€', 'Nun', 'DÃ©but'), mkB('Ù€Ø¬Ù’Ù€', 'Jim', 'Milieu'), mkB('Ù€Ù…', 'Mim', 'Fin')]),
            mkW('Ø¨ÙØ­Ù’Ø±', ['bahr'], 'Mer', [mkB('Ø¨ÙÙ€', 'Ba', 'DÃ©but'), mkB('Ù€Ø­Ù’Ù€', 'Ha', 'Milieu'), mkB('Ù€Ø±', 'Ra', 'Fin')]),
            mkW('ØºÙØ±Ù’ÙÙØ©', ['ghurfa'], 'Chambre', [mkB('ØºÙÙ€', 'Ghayn', 'DÃ©but'), mkB('Ù€Ø±Ù’', 'Ra', 'Fin'), mkB('ÙÙÙ€', 'Fa', 'DÃ©but'), mkB('Ù€Ø©', 'Ta marb.', 'Fin')]),
            mkW('Ù‚ÙÙ‡Ù’ÙˆÙØ©', ['qahwa', 'kahwa'], 'CafÃ©', [mkB('Ù‚ÙÙ€', 'Qaf', 'DÃ©but'), mkB('Ù€Ù‡Ù’Ù€', 'Ha', 'Milieu'), mkB('ÙˆÙ', 'Waw', 'Rebelle'), mkB('Ø©', 'Ta marb.', 'IsolÃ©e')]),
            mkW('Ø´ÙØ§ÙŠ', ['shay', 'chai'], 'ThÃ©', [mkB('Ø´ÙÙ€', 'Shin', 'DÃ©but'), mkB('Ø§', 'Alif', 'Rebelle'), mkB('ÙŠ', 'Ya', 'IsolÃ©e')]),
            mkW('Ø°ÙÙ‡ÙØ¨', ['dhahab'], 'Or', [mkB('Ø°Ù', 'Dhal', 'Rebelle'), mkB('Ù‡ÙÙ€', 'Ha', 'DÃ©but'), mkB('Ù€Ø¨', 'Ba', 'Fin')]),
            mkW('Ø£ÙØ­Ù’Ù…ÙØ±', ['ahmar'], 'Rouge', [mkB('Ø£Ù', 'Alif', 'Rebelle'), mkB('Ø­Ù’Ù€', 'Ha', 'DÃ©but'), mkB('Ù€Ù…ÙÙ€', 'Mim', 'Milieu'), mkB('Ù€Ø±', 'Ra', 'Fin')]),
            mkW('Ø£ÙØ¨Ù’ÙŠÙØ¶', ['abyad'], 'Blanc', [mkB('Ø£Ù', 'Alif', 'Rebelle'), mkB('Ø¨Ù’Ù€', 'Ba', 'DÃ©but'), mkB('Ù€ÙŠÙÙ€', 'Ya', 'Milieu'), mkB('Ù€Ø¶', 'Dad', 'Fin')]),
            mkW('Ø£ÙØ³Ù’ÙˆÙØ¯', ['aswad'], 'Noir', [mkB('Ø£Ù', 'Alif', 'Rebelle'), mkB('Ø³Ù’Ù€', 'Sin', 'DÃ©but'), mkB('Ù€ÙˆÙ', 'Waw', 'Fin'), mkB('Ø¯', 'Dal', 'IsolÃ©e')]),
            mkW('Ø£ÙØ®Ù’Ø¶ÙØ±', ['akhdar'], 'Vert', [mkB('Ø£Ù', 'Alif', 'Rebelle'), mkB('Ø®Ù’Ù€', 'Kha', 'DÃ©but'), mkB('Ù€Ø¶ÙÙ€', 'Dad', 'Milieu'), mkB('Ù€Ø±', 'Ra', 'Fin')]),
            mkW('Ø·ÙØ±ÙÙŠÙ‚', ['tariq', 'tareek'], 'Chemin', [mkB('Ø·ÙÙ€', 'Ta', 'DÃ©but'), mkB('Ù€Ø±Ù', 'Ra', 'Fin'), mkB('ÙŠÙ€', 'Ya', 'DÃ©but'), mkB('Ù€Ù‚', 'Qaf', 'Fin')]),
            mkW('Ø²ÙÙ‡Ù’Ø±ÙØ©', ['zahra'], 'Fleur', [mkB('Ø²Ù', 'Zay', 'Rebelle'), mkB('Ù‡Ù’Ù€', 'Ha', 'DÃ©but'), mkB('Ù€Ø±Ù', 'Ra', 'Fin'), mkB('Ø©', 'Ta marb.', 'IsolÃ©e')]),
            mkW('Ù„ÙØ­Ù’Ù…', ['lahm'], 'Viande', [mkB('Ù„ÙÙ€', 'Lam', 'DÃ©but'), mkB('Ù€Ø­Ù’Ù€', 'Ha', 'Milieu'), mkB('Ù€Ù…', 'Mim', 'Fin')]),
            mkW('ÙˆÙØ¬Ù’Ù‡', ['wajh'], 'Visage', [mkB('ÙˆÙ', 'Waw', 'Rebelle'), mkB('Ø¬Ù’Ù€', 'Jim', 'DÃ©but'), mkB('Ù€Ù‡', 'Ha', 'Fin')]),
            mkW('Ø¯ÙÙŠÙƒ', ['dik'], 'Coq', [mkB('Ø¯Ù', 'Dal', 'Rebelle'), mkB('ÙŠÙ€', 'Ya', 'DÃ©but'), mkB('Ù€Ùƒ', 'Kaf', 'Fin')])
        ];

        // ===== TASHKEEL DATA (generated) =====
        const vowelDefs = [{ s: '\u064E', n: 'Fatha', snd: 'a', ar: 'ÙÙØªÙ’Ø­ÙØ©' }, { s: '\u0650', n: 'Kasra', snd: 'i', ar: 'ÙƒÙØ³Ù’Ø±ÙØ©' }, { s: '\u064F', n: 'Damma', snd: 'u', ar: 'Ø¶ÙÙ…ÙÙ‘Ø©' }, { s: '\u0652', n: 'Sukun', snd: '', ar: 'Ø³ÙÙƒÙÙˆÙ†' }, { s: '\u0651', n: 'Shadda', snd: '(double)', ar: 'Ø´ÙØ¯ÙÙ‘Ø©' }];
        const ltSnd = { Ø¨: 'b', Øª: 't', Ø«: 'th', Ø¬: 'j', Ø­: 'h', Ø®: 'kh', Ø¯: 'd', Ø°: 'dh', Ø±: 'r', Ø²: 'z', Ø³: 's', Ø´: 'sh', Øµ: 's', Ø¶: 'd', Ø·: 't', Ø¸: 'z', Ø¹: '3', Øº: 'gh', Ù: 'f', Ù‚: 'q', Ùƒ: 'k', Ù„: 'l', Ù…: 'm', Ù†: 'n', Ù‡: 'h', Ùˆ: 'w', ÙŠ: 'y' };
        const ltNm = { Ø¨: 'Ba', Øª: 'Ta', Ø«: 'Tha', Ø¬: 'Jim', Ø­: 'Ha', Ø®: 'Kha', Ø¯: 'Dal', Ø°: 'Dhal', Ø±: 'Ra', Ø²: 'Zay', Ø³: 'Sin', Ø´: 'Shin', Øµ: 'Sad', Ø¶: 'Dad', Ø·: 'Ta', Ø¸: 'Za', Ø¹: 'Ayn', Øº: 'Ghayn', Ù: 'Fa', Ù‚: 'Qaf', Ùƒ: 'Kaf', Ù„: 'Lam', Ù…: 'Mim', Ù†: 'Nun', Ù‡: 'Ha', Ùˆ: 'Waw', ÙŠ: 'Ya' };
        const tashkeelLetters = 'Ø¨ØªØ«Ø¬Ø­Ø®Ø¯Ø°Ø±Ø²Ø³Ø´ØµØ¶Ø·Ø¸Ø¹ØºÙÙ‚ÙƒÙ„Ù…Ù†Ù‡ÙˆÙŠ'.split('');
        let tashkeelData = [];
        function genTashkeel() { tashkeelData = []; const mainV = vowelDefs.slice(0, 3); tashkeelLetters.forEach(lt => { mainV.forEach(v => { const snd = ltSnd[lt] + v.snd; const alts = [snd]; if (lt === 'Ø¬') alts.push('dj' + v.snd); if (lt === 'Ø´') alts.push('ch' + v.snd); if (lt === 'Ø¹') alts.push('a' + v.snd, 'ai' + v.snd); tashkeelData.push({ display: lt + v.s, audio: lt + v.s, accepted: alts, vowelName: v.n, letterName: ltNm[lt], weight: 1, errors: 0, successes: 0, isMastered: false }); }); }); }

        // ===== SYLLABLE DATA (Nour Al-Bayan method) =====
        let sylData = [];
        function genSyllables() { sylData = []; const vMap = { fatha: { s: '\u064E', snd: 'a' }, kasra: { s: '\u0650', snd: 'i' }, damma: { s: '\u064F', snd: 'u' } }; Object.keys(vMap).forEach(vk => { const v = vMap[vk]; tashkeelLetters.forEach(lt => { const snd = ltSnd[lt] + v.snd; const alts = [snd]; if (lt === 'Ø¬') alts.push('dj' + v.snd); if (lt === 'Ø´') alts.push('ch' + v.snd); if (lt === 'Ø¹') alts.push('a' + v.snd); sylData.push({ display: lt + v.s, audio: lt + v.s, accepted: alts, vowelType: vk, letterName: ltNm[lt], weight: 1, errors: 0, successes: 0, isMastered: false }); }); }); }

        // ===== STATS tracking =====
        let stats = { lettersCorrect: 0, lettersWrong: 0, wordsCorrect: 0, wordsWrong: 0, tashkeelCorrect: 0, tashkeelWrong: 0, sylCorrect: 0, sylWrong: 0 };

        // ===== LETTER QUIZ =====
        let curLetter = {};
        function resetLetterQuiz() {
            document.getElementById('l-victory').style.display = 'none';
            document.getElementById('l-core').style.display = 'block';
            const f = document.getElementById('family-filter').value;
            const pool = (f !== 'all') ? alphabetData.filter(i => i.family === f) : alphabetData;
            pool.forEach(i => { i.isMastered = false; i.weight = 1; });
            nextLetter();
        }
        function updateLetterProg() {
            const f = document.getElementById('family-filter').value;
            const pool = (f !== 'all') ? alphabetData.filter(i => i.family === f) : alphabetData;
            const done = pool.filter(i => i.isMastered).length;
            document.getElementById('l-prog').style.width = ((done / pool.length) * 100) + '%';
            document.getElementById('l-prog-txt').textContent = done + '/' + pool.length;
        }
        function nextLetter() {
            const f = document.getElementById('family-filter').value;
            const pool = (f !== 'all') ? alphabetData.filter(i => i.family === f) : alphabetData;
            const item = srsSelect(pool);
            if (!item) { document.getElementById('l-core').style.display = 'none'; document.getElementById('l-victory').style.display = 'block'; return; }
            curLetter = item;
            document.getElementById('l-char').textContent = curLetter.char;
            document.getElementById('l-word').style.display = 'none';
            document.getElementById('l-inp-name').value = ''; document.getElementById('l-inp-pos').value = '';
            document.getElementById('l-fb').innerHTML = ''; document.getElementById('l-tip').style.display = 'none';
            document.getElementById('l-submit').style.display = 'inline-block';
            document.getElementById('l-next').style.display = 'none'; document.getElementById('l-audio1').style.display = 'none'; document.getElementById('l-audio2').style.display = 'none';
            document.getElementById('l-inp-name').focus();
            updateLetterProg();
        }
        function checkLetter() {
            const uN = norm(document.getElementById('l-inp-name').value);
            const uP = norm(document.getElementById('l-inp-pos').value);
            const nameOk = curLetter.names.some(n => norm(n) === uN);
            const posOk = (uP === curLetter.pos || (curLetter.pos === 'isolee' && (uP === 'isole' || uP === 'isolee')) || (curLetter.pos === 'debut' && uP === 'commencement'));
            if (nameOk && posOk) { srsCorrect(curLetter); stats.lettersCorrect++; addXP(10); checkStreak(); document.getElementById('l-fb').innerHTML = '<span class="correct">Excellent ! ValidÃ© âœ”ï¸</span>'; }
            else { srsWrong(curLetter); stats.lettersWrong++; document.getElementById('l-fb').innerHTML = '<span class="incorrect">Elle reste dans la pile !</span><br>C\'Ã©tait : <b>' + curLetter.names[0].toUpperCase() + '</b> en position <b>' + curLetter.pos + '</b>'; }
            const wd = document.getElementById('l-word');
            wd.innerHTML = curLetter.word + '<br><span style="font-size:20px;color:#a29bfe;font-weight:bold;">[ ' + curLetter.phonetic + ' ]</span><br><span style="font-size:16px;color:rgba(255,255,255,0.5);">' + curLetter.translation + '</span>';
            wd.style.display = 'block';
            playAudio(curLetter.audioChar);
            document.getElementById('l-submit').style.display = 'none';
            document.getElementById('l-audio1').style.display = 'inline-block'; document.getElementById('l-audio2').style.display = 'inline-block'; document.getElementById('l-next').style.display = 'inline-block';
            updateLetterProg(); saveState();
        }

        // ===== WORD QUIZ =====
        let curWord = {};
        function getWordPool() {
            const d = document.getElementById('word-diff').value;
            if (d === 'short') return wordsData.filter(w => w.breakdown.length <= 3);
            if (d === 'medium') return wordsData.filter(w => w.breakdown.length === 4);
            if (d === 'long') return wordsData.filter(w => w.breakdown.length >= 5);
            return wordsData;
        }
        function resetWordQuiz() {
            document.getElementById('w-victory').style.display = 'none';
            document.getElementById('w-core').style.display = 'block';
            getWordPool().forEach(i => { i.isMastered = false; i.weight = 1; });
            nextWord();
        }
        function updateWordProg() {
            const pool = getWordPool(); const done = pool.filter(i => i.isMastered).length;
            document.getElementById('w-prog').style.width = ((done / pool.length) * 100) + '%';
            document.getElementById('w-prog-txt').textContent = done + '/' + pool.length;
        }
        function nextWord() {
            const pool = getWordPool(); const item = srsSelect(pool);
            if (!item) { document.getElementById('w-core').style.display = 'none'; document.getElementById('w-victory').style.display = 'block'; return; }
            curWord = item;
            document.getElementById('w-display').textContent = curWord.arabic;
            document.getElementById('w-inp').value = ''; document.getElementById('w-fb').innerHTML = ''; document.getElementById('w-bd').innerHTML = '';
            document.getElementById('w-submit').style.display = 'inline-block'; document.getElementById('w-next').style.display = 'none'; document.getElementById('w-audio').style.display = 'none';
            document.getElementById('w-inp').focus(); updateWordProg();
        }
        function checkWord() {
            const u = norm(document.getElementById('w-inp').value);
            const ok = curWord.acceptedPhonetics.some(p => norm(p) === u);
            if (ok) {
                srsCorrect(curWord); stats.wordsCorrect++; addXP(15); checkStreak();
                document.getElementById('w-fb').innerHTML = '<span class="correct">Bravo ! âœ”ï¸</span><br><span style="color:rgba(255,255,255,0.5);">' + curWord.translation + '</span>';
            } else {
                srsWrong(curWord); stats.wordsWrong++;
                document.getElementById('w-fb').innerHTML = '<span class="incorrect">Le mot retourne dans la pile !</span><br>C\'Ã©tait : <b>[ ' + curWord.acceptedPhonetics[0] + ' ]</b><br><span style="color:rgba(255,255,255,0.5);">' + curWord.translation + '</span>';
            }
            // Breakdown
            const colors = ['#e74c3c', '#6c5ce7', '#00b894', '#fdcb6e', '#fd79a8', '#e17055'];
            let h = '<div class="bd-wrap">';
            curWord.breakdown.forEach((b, i) => {
                const c = colors[i % colors.length];
                h += '<div class="bd-item" style="border-bottom-color:' + c + '"><div class="bd-char" style="color:' + c + '">' + b.char + '</div><div class="bd-desc"><b>' + b.name + '</b><br>(' + b.pos + ')</div></div>';
                if (i < curWord.breakdown.length - 1) h += '<div class="bd-plus">+</div>';
            }); h += '</div>';
            document.getElementById('w-bd').innerHTML = h;
            playAudio(curWord.arabic);
            document.getElementById('w-submit').style.display = 'none'; document.getElementById('w-audio').style.display = 'inline-block'; document.getElementById('w-next').style.display = 'inline-block';
            updateWordProg(); saveState();
        }

        // ===== TASHKEEL QUIZ =====
        let curTash = {};
        function resetTashkeelQuiz() {
            document.getElementById('t-victory').style.display = 'none';
            document.getElementById('t-core').style.display = 'block';
            tashkeelData.forEach(i => { i.isMastered = false; i.weight = 1; });
            nextTashkeel();
        }
        function updateTashkeelProg() {
            const done = tashkeelData.filter(i => i.isMastered).length;
            document.getElementById('t-prog').style.width = ((done / tashkeelData.length) * 100) + '%';
            document.getElementById('t-prog-txt').textContent = done + '/' + tashkeelData.length;
        }
        function nextTashkeel() {
            const item = srsSelect(tashkeelData);
            if (!item) { document.getElementById('t-core').style.display = 'none'; document.getElementById('t-victory').style.display = 'block'; return; }
            curTash = item;
            document.getElementById('t-display').textContent = curTash.display;
            document.getElementById('t-inp').value = ''; document.getElementById('t-fb').innerHTML = '';
            document.getElementById('t-submit').style.display = 'inline-block'; document.getElementById('t-next').style.display = 'none'; document.getElementById('t-audio').style.display = 'none';
            document.getElementById('t-inp').focus(); updateTashkeelProg();
        }
        function checkTashkeel() {
            const u = norm(document.getElementById('t-inp').value);
            const ok = curTash.accepted.some(a => norm(a) === u);
            if (ok) {
                srsCorrect(curTash); stats.tashkeelCorrect++; addXP(8); checkStreak();
                document.getElementById('t-fb').innerHTML = '<span class="correct">Correct ! âœ”ï¸</span><br><span style="color:rgba(255,255,255,0.5);">' + curTash.letterName + ' + ' + curTash.vowelName + ' = ' + curTash.accepted[0] + '</span>';
            } else {
                srsWrong(curTash); stats.tashkeelWrong++;
                document.getElementById('t-fb').innerHTML = '<span class="incorrect">Non... c\'Ã©tait <b>' + curTash.accepted[0] + '</b></span><br><span style="color:rgba(255,255,255,0.5);">' + curTash.letterName + ' + ' + curTash.vowelName + '</span>';
            }
            playAudio(curTash.audio);
            document.getElementById('t-submit').style.display = 'none'; document.getElementById('t-audio').style.display = 'inline-block'; document.getElementById('t-next').style.display = 'inline-block';
            updateTashkeelProg(); saveState();
        }

        // ===== SYLLABLE QUIZ =====
        let curSyl = {};
        function resetSylQuiz() {
            document.getElementById('s-victory').style.display = 'none';
            document.getElementById('s-core').style.display = 'block';
            const f = document.getElementById('syl-filter').value;
            const pool = (f !== 'all') ? sylData.filter(i => i.vowelType === f) : sylData;
            pool.forEach(i => { i.isMastered = false; i.weight = 1; });
            nextSyl();
        }
        function updateSylProg() {
            const f = document.getElementById('syl-filter').value;
            const pool = (f !== 'all') ? sylData.filter(i => i.vowelType === f) : sylData;
            const done = pool.filter(i => i.isMastered).length;
            document.getElementById('s-prog').style.width = ((done / pool.length) * 100) + '%';
            document.getElementById('s-prog-txt').textContent = done + '/' + pool.length;
        }
        function nextSyl() {
            const f = document.getElementById('syl-filter').value;
            const pool = (f !== 'all') ? sylData.filter(i => i.vowelType === f) : sylData;
            const item = srsSelect(pool);
            if (!item) { document.getElementById('s-core').style.display = 'none'; document.getElementById('s-victory').style.display = 'block'; return; }
            curSyl = item;
            document.getElementById('s-display').textContent = curSyl.display;
            document.getElementById('s-inp').value = ''; document.getElementById('s-fb').innerHTML = '';
            document.getElementById('s-submit').style.display = 'inline-block'; document.getElementById('s-next').style.display = 'none'; document.getElementById('s-audio').style.display = 'none';
            document.getElementById('s-inp').focus(); updateSylProg();
        }
        function checkSyl() {
            const u = norm(document.getElementById('s-inp').value);
            const ok = curSyl.accepted.some(a => norm(a) === u);
            if (ok) {
                srsCorrect(curSyl); stats.sylCorrect++; addXP(8); checkStreak();
                document.getElementById('s-fb').innerHTML = '<span class="correct">Bravo ! âœ”ï¸</span><br><span style="color:rgba(255,255,255,0.5);">' + curSyl.letterName + ' = ' + curSyl.accepted[0] + '</span>';
            } else {
                srsWrong(curSyl); stats.sylWrong++;
                document.getElementById('s-fb').innerHTML = '<span class="incorrect">C\'Ã©tait <b>' + curSyl.accepted[0] + '</b></span><br><span style="color:rgba(255,255,255,0.5);">' + curSyl.letterName + '</span>';
            }
            playAudio(curSyl.audio);
            document.getElementById('s-submit').style.display = 'none'; document.getElementById('s-audio').style.display = 'inline-block'; document.getElementById('s-next').style.display = 'inline-block';
            updateSylProg(); saveState();
        }

        // ===== VIRTUAL KEYBOARD =====
        const vkLettersList = 'Ø§Ø¨ØªØ«Ø¬Ø­Ø®Ø¯Ø°Ø±Ø²Ø³Ø´ØµØ¶Ø·Ø¸Ø¹ØºÙÙ‚ÙƒÙ„Ù…Ù†Ù‡ÙˆÙŠØ¡Ø©'.split('');
        const vkTashkeelList = [
            { char: '\u064E', label: 'Ø¨\u064E', name: 'Fatha' },
            { char: '\u064F', label: 'Ø¨\u064F', name: 'Damma' },
            { char: '\u0650', label: 'Ø¨\u0650', name: 'Kasra' },
            { char: '\u0652', label: 'Ø¨\u0652', name: 'Sukun' },
            { char: '\u0651', label: 'Ø¨\u0651', name: 'Shadda' },
            { char: '\u064B', label: 'Ø¨\u064B', name: 'Fathatan' },
            { char: '\u064C', label: 'Ø¨\u064C', name: 'Dammatan' },
            { char: '\u064D', label: 'Ø¨\u064D', name: 'Kasratan' }
        ];
        function initVirtualKeyboard() {
            const lr = document.getElementById('vk-letters');
            vkLettersList.forEach(ch => {
                const btn = document.createElement('button');
                btn.className = 'vk-key';
                btn.textContent = ch;
                btn.onclick = () => vkType(ch);
                lr.appendChild(btn);
            });
            const tr = document.getElementById('vk-tashkeel');
            vkTashkeelList.forEach(t => {
                const btn = document.createElement('button');
                btn.className = 'vk-key vk-key-tashkeel';
                btn.textContent = t.label;
                btn.title = t.name;
                btn.onclick = () => vkType(t.char);
                tr.appendChild(btn);
            });
        }
        function vkType(ch) {
            const inp = document.getElementById('d-inp');
            inp.textContent += ch;
        }
        function vkBackspace() {
            const inp = document.getElementById('d-inp');
            const txt = inp.textContent;
            if (txt.length > 0) inp.textContent = txt.slice(0, -1);
        }
        function vkClear() {
            document.getElementById('d-inp').textContent = '';
        }

        // ===== MICROPHONE (Speech to Text) =====
        let recognition = null;
        let isRecording = false;
        function vkMic() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                showToast("Microphone non supportÃ© sur ce navigateur.", "toast-streak");
                return;
            }
            if (isRecording) {
                if (recognition) recognition.stop();
                return;
            }
            try {
                const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRec();
                recognition.lang = 'ar-SA'; // RÃ©glÃ© sur Arabe Saoudien
                recognition.continuous = false;
                recognition.interimResults = false;

                recognition.onstart = function () {
                    isRecording = true;
                    document.getElementById('mic-btn').style.background = '#e17055';
                    document.getElementById('mic-btn').style.color = '#fff';
                    showToast("ğŸ™ï¸ Ã‰coute...");
                };
                recognition.onresult = function (event) {
                    let transcript = event.results[0][0].transcript;
                    // On peut retirer les espaces pour que Ã§a matche sans problÃ¨me
                    transcript = transcript.replace(/[\s\.]/g, '');
                    vkType(transcript);
                };
                recognition.onerror = function (event) {
                    showToast("Erreur micro : " + event.error, "toast-streak");
                };
                recognition.onend = function () {
                    isRecording = false;
                    document.getElementById('mic-btn').style.background = '';
                    document.getElementById('mic-btn').style.color = '';
                };
                recognition.start();
            } catch (e) {
                showToast("Erreur d'initialisation du micro");
            }
        }

        // ===== DICTEE QUIZ =====
        let curDictee = {}, dicteePool = [];
        function normAr(s) {
            // On retire les espaces, alif dagger, et tous les tashkeel (voyelles) pour comparer facilement la dictÃ©e vocale
            return s.replace(/\s/g, '').replace(/[\u064B-\u065F\u0670]/g, '').trim();
        }
        function getDicteePool() {
            const mode = document.getElementById('dictee-mode').value;
            if (mode === 'syllables') return sylData.map(s => ({ audio: s.audio, arabic: s.display, label: s.display, type: 'syllabe' }));
            return wordsData.map(w => ({ audio: w.arabic, arabic: w.arabic, label: w.arabic, translation: w.translation, type: 'mot' }));
        }
        function resetDicteeQuiz() {
            document.getElementById('d-victory').style.display = 'none';
            document.getElementById('d-core').style.display = 'block';
            dicteePool = getDicteePool();
            dicteePool.forEach(i => { i.dMastered = false; i.dWeight = i.dWeight || 1; });
            nextDictee();
        }
        function updateDicteeProg() {
            const done = dicteePool.filter(i => i.dMastered).length;
            document.getElementById('d-prog').style.width = ((done / dicteePool.length) * 100) + '%';
            document.getElementById('d-prog-txt').textContent = done + '/' + dicteePool.length;
        }
        function nextDictee() {
            const active = dicteePool.filter(i => !i.dMastered);
            if (!active.length) { document.getElementById('d-core').style.display = 'none'; document.getElementById('d-victory').style.display = 'block'; return; }
            const totalW = active.reduce((s, i) => s + (i.dWeight || 1), 0);
            let r = Math.random() * totalW;
            curDictee = active[active.length - 1];
            for (const item of active) { r -= (item.dWeight || 1); if (r <= 0) { curDictee = item; break; } }
            document.getElementById('d-inp').textContent = ''; document.getElementById('d-fb').innerHTML = '';
            document.getElementById('d-reveal').style.display = 'none';
            document.getElementById('d-submit').style.display = 'inline-block'; document.getElementById('d-next').style.display = 'none';
            updateDicteeProg();
            setTimeout(() => playDictee(), 400);
        }
        function playDictee() { playAudio(curDictee.audio); }
        function checkDictee() {
            const userText = normAr(document.getElementById('d-inp').textContent);
            const expected = normAr(curDictee.arabic);
            const ok = userText === expected;
            const reveal = document.getElementById('d-reveal');
            reveal.textContent = curDictee.label;
            reveal.style.display = 'block';
            if (ok) {
                curDictee.dMastered = true; curDictee.dWeight = Math.max(1, (curDictee.dWeight || 1) - 1);
                addXP(15); checkStreak();
                let extra = curDictee.translation ? '<br><span style="color:rgba(255,255,255,0.5);">' + curDictee.translation + '</span>' : '';
                document.getElementById('d-fb').innerHTML = '<span class="correct">Bravo ! \u2714\ufe0f</span>' + extra;
            } else {
                curDictee.dWeight = Math.min(10, (curDictee.dWeight || 1) + 2);
                document.getElementById('d-fb').innerHTML = '<span class="incorrect">C\'\u00e9tait <b style="font-family:Amiri,serif;font-size:24px;">' + curDictee.arabic + '</b></span>';
            }
            playAudio(curDictee.audio);
            document.getElementById('d-submit').style.display = 'none'; document.getElementById('d-next').style.display = 'inline-block';
            updateDicteeProg(); saveState();
        }

        // ===== ALPHABET GRID =====
        function initAlphabetGrid() {
            const g = document.getElementById('alpha-grid');
            baseAlphabet.forEach(l => {
                const card = document.createElement('div');
                card.className = 'alpha-card' + (l.r ? ' rebel' : '');
                card.onclick = () => playAudio(l.aud);
                const formsStr = l.fm.filter(f => f !== '').join(' ');
                card.innerHTML = '<div class="ch">' + l.c + '</div><div class="nm">' + l.n + '</div><div class="forms">' + formsStr + '</div>' + (l.r ? '<span class="rebel-tag">Rebelle</span>' : '');
                g.appendChild(card);
            });
        }

        // ===== TASHKEEL REFERENCE CARDS =====
        function initTashkeelRef() {
            const r = document.getElementById('tashkeel-ref');
            const examples = [
                { ar: 'Ø¨Ù', nm: 'Fatha', snd: 'a', desc: 'Ouvre la bouche' },
                { ar: 'Ø¨Ù', nm: 'Kasra', snd: 'i', desc: 'Souris !' },
                { ar: 'Ø¨Ù', nm: 'Damma', snd: 'u', desc: 'Arrondis les lÃ¨vres' },
                { ar: 'Ø¨Ù’', nm: 'Sukun', snd: 'â€”', desc: 'Pas de voyelle' },
                { ar: 'Ø¨Ù‘', nm: 'Shadda', snd: 'bb', desc: 'Double la lettre' }
            ];
            examples.forEach(e => {
                const card = document.createElement('div'); card.className = 'tashkeel-card';
                card.innerHTML = '<div class="tc-ar">' + e.ar + '</div><div class="tc-nm">' + e.nm + '</div><div class="tc-snd">' + e.snd + '</div>';
                card.onclick = () => playAudio(e.ar); card.style.cursor = 'pointer';
                r.appendChild(card);
            });
        }

        // ===== STATS DASHBOARD =====
        function refreshStats() {
            const grid = document.getElementById('stat-grid');
            const totalCorrect = stats.lettersCorrect + stats.wordsCorrect + stats.tashkeelCorrect + stats.sylCorrect;
            const totalWrong = stats.lettersWrong + stats.wordsWrong + stats.tashkeelWrong + stats.sylWrong;
            const rate = totalCorrect + totalWrong > 0 ? Math.round((totalCorrect / (totalCorrect + totalWrong)) * 100) : 0;
            const lMastered = alphabetData.filter(i => i.isMastered).length;
            const wMastered = wordsData.filter(i => i.isMastered).length;
            const tMastered = tashkeelData.filter(i => i.isMastered).length;
            const sMastered = sylData.filter(i => i.isMastered).length;
            grid.innerHTML = `
        <div class="stat-card"><div class="st-val" style="color:#6c5ce7">â­ ${level}</div><div class="st-lbl">Niveau</div></div>
        <div class="stat-card"><div class="st-val" style="color:#fdcb6e">ğŸ”¥ ${streak}</div><div class="st-lbl">Streak (jours)</div></div>
        <div class="stat-card"><div class="st-val" style="color:#00b894">${rate}%</div><div class="st-lbl">Taux de rÃ©ussite</div></div>
        <div class="stat-card"><div class="st-val" style="color:#a29bfe">${totalCorrect}</div><div class="st-lbl">Bonnes rÃ©ponses</div></div>
        <div class="stat-card"><div class="st-val" style="color:#00cec9">${lMastered}/${alphabetData.length}</div><div class="st-lbl">Lettres validÃ©es</div></div>
        <div class="stat-card"><div class="st-val" style="color:#fd79a8">${wMastered}/${wordsData.length}</div><div class="st-lbl">Mots validÃ©s</div></div>
        <div class="stat-card"><div class="st-val" style="color:#e17055">${tMastered}/${tashkeelData.length}</div><div class="st-lbl">Tashkeel validÃ©</div></div>
        <div class="stat-card"><div class="st-val" style="color:#6c5ce7">${sMastered}/${sylData.length}</div><div class="st-lbl">Syllabes validÃ©es</div></div>`;
            // Weak items
            const allItems = [...alphabetData.map(i => ({ label: i.char, errors: i.errors, type: 'Lettre' })), ...wordsData.map(i => ({ label: i.arabic, errors: i.errors, type: 'Mot' })), ...tashkeelData.map(i => ({ label: i.display, errors: i.errors, type: 'Tashkeel' }))];
            const weak = allItems.filter(i => i.errors > 0).sort((a, b) => b.errors - a.errors).slice(0, 6);
            const wl = document.getElementById('weak-list');
            if (weak.length === 0) { wl.innerHTML = '<p style="color:rgba(255,255,255,0.3);text-align:center;">Aucune erreur pour le moment ğŸ‰</p>'; return; }
            wl.innerHTML = weak.map(w => '<div class="weak-item"><span class="ar">' + w.label + '</span><span class="wi-info">' + w.type + ' â€” ' + w.errors + ' erreur(s)</span></div>').join('');
        }

        // ===== KEYBOARD =====
        document.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                if (curTab === 'letters' && document.getElementById('l-core').style.display !== 'none') {
                    if (document.getElementById('l-submit').style.display !== 'none') checkLetter(); else nextLetter();
                } else if (curTab === 'words' && document.getElementById('w-core').style.display !== 'none') {
                    if (document.getElementById('w-submit').style.display !== 'none') checkWord(); else nextWord();
                } else if (curTab === 'tashkeel' && document.getElementById('t-core').style.display !== 'none') {
                    if (document.getElementById('t-submit').style.display !== 'none') checkTashkeel(); else nextTashkeel();
                } else if (curTab === 'syllables' && document.getElementById('s-core').style.display !== 'none') {
                    if (document.getElementById('s-submit').style.display !== 'none') checkSyl(); else nextSyl();
                } else if (curTab === 'dictee' && document.getElementById('d-core').style.display !== 'none') {
                    if (document.getElementById('d-submit').style.display !== 'none') checkDictee(); else nextDictee();
                }
            }
        });

        // ===== INIT =====
        window.onload = function () {
            genTashkeel(); genSyllables();
            const hadState = loadState();
            initTabs(); initFamilyFilter(); initAlphabetGrid(); initTashkeelRef(); initVirtualKeyboard();
            tabInitialized.letters = true;
            if (hadState) { switchTab(curTab); updateGamiBar(); }
            resetLetterQuiz();
            checkStreak(); updateGamiBar();
        };
    </script>
</body>

</html>